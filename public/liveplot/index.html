<!doctype html>
<html>
<head>
<title id="page_title">liveplot2_mkturk</title>
<script src="liveplot_utils.js"></script>
<script type="text/javascript" src="https://www.gstatic.com/charts/loader.js"></script>
<script src="liveplot2_googlecharts.js" type="text/javascript"></script>
<script src="mkturk_installsettings.js"></script>
<style type='text/css'>
.small-font {
    font-size: 8px;
}

.medium-font {
    font-size: 10px;
}
</style>

<!-- Firebase App is always required and must be first -->
<script src="https://www.gstatic.com/firebasejs/6.1.0/firebase.js"></script>
<script src="https://www.gstatic.com/firebasejs/6.1.0/firebase-app.js"></script>

<!-- Add additional services that you want to use -->
<script src="https://www.gstatic.com/firebasejs/6.1.0/firebase-auth.js"></script>
<script src="https://www.gstatic.com/firebasejs/6.1.0/firebase-storage.js"></script>

<script>
  // Initialize Firebase
  var config = {
    apiKey: "AIzaSyA0fbv2VqE-AfF6V_nxSSXCEqaTlBlZnTI",
    authDomain: "sandbox-ce2c5.firebaseapp.com",
    databaseURL: "https://sandbox-ce2c5.firebaseio.com",
    projectId: "sandbox-ce2c5",
    storageBucket: "sandbox-ce2c5.appspot.com",
    messagingSenderId: "1003719887944"
  };
  firebase.initializeApp(config);

  //Initialize Cloud Storage
  var storage = firebase.storage();
</script>


<script type="text/javascript">
// Flow: 
// authenticate --> loadGoogleCharts --> getfilesfromfirebase
// checkFileStatus -- wait 1 second -- if new data -->
// readDatafromFirebase --> initializeChartData --> updatePlots

// SECTIONS:
//================== AUTHENICATION ==================//
//================== GOOGLE CHARTS LOADING ==================//
//================== FIREBASE STUFF ==================//
//================== DATA HANDLING ==================//
//================== PLOTTING ==================//

//================== GOOGLE CHARTS LOADING ==================//
// Asynchronous: Live plotting using google charts
function loadGoogleCharts() {
    // Load the Visualization API and the piechart package.
    google.charts.load('current', {
        'packages': ['corechart', 'bar', 'table', 'controls']
    });
    google.charts.setOnLoadCallback(function() {
        dataPerformance = new google.visualization.DataTable()
        dataCumulative = new google.visualization.DataTable()
        dataXYPos = new google.visualization.DataTable()
        dataReactionTime = new google.visualization.DataTable()
        dataReward = new google.visualization.DataTable()
        dataChoice = new google.visualization.DataTable()
        dataObjPerf = new google.visualization.DataTable()
        dataWeight = new google.visualization.DataTable()
     
        // Establish dependencies, declaring that the sliders drive 'liveline' & 'livearea',
        // so that data will only display for entries that are let through
        // given the chosen slider range.

        // Create a dashboard.
        dashboard1 = new google.visualization.Dashboard(
            document.getElementById('dashboard1_div'));

        // Initialize plotting elements
        // See for chartrange example: https://google-developers.appspot.com/chart/interactive/docs/gallery/controls_5cece98b344aa0b1575282db7d34d5f4.frame
        livesliderTrial = new google.visualization.ControlWrapper({
            'controlType': 'ChartRangeFilter',
            'containerId': 'filtertrial_div',
            'options': livesliderTrialOptions,
            'state': {'range': {'start': 0, 'end': 100}}
        }) //wrapper

        liveline = new google.visualization.ChartWrapper({
            'chartType': 'LineChart',
            'containerId': 'line_div'
        })
    
       dashboard2 = new google.visualization.Dashboard(document.getElementById('dashboard2_div'));

        livesliderTime = new google.visualization.ControlWrapper({
            'controlType': 'ChartRangeFilter',
            'containerId': 'filtertime_div',
            'options': livesliderTimeOptions,
            'state': {
                'range': {
                    'start': 0,
                    'end': 100
                }
            }
        })
        //wrapper

        livearea = new google.visualization.ChartWrapper({
            'chartType': 'AreaChart',
            'containerId': 'area_div'
        })

        dashboard1.bind(livesliderTrial, liveline)
        dashboard2.bind(livesliderTime, livearea)

        livescatter = new google.visualization.ComboChart(document.getElementById('scatter_div'));
        livereactiontime = new google.visualization.Histogram(document.getElementById('reactiontime_div'));
        livereward = new google.visualization.ColumnChart(document.getElementById('reward_div'));
        livechoice = new google.visualization.ColumnChart(document.getElementById('choice_div'));
        liveobjperf = new google.visualization.ColumnChart(document.getElementById('objectPerf_div'));
        
        liveweight = new google.visualization.ColumnChart(document.getElementById('weight_div'));
       
        
        // data formatters
        formatterDate = new google.visualization.DateFormat({
            pattern: 'h aa'
        })
        formatterDigits = new google.visualization.NumberFormat({
            fractionDigits: 2
        })
        formatterColor = new google.visualization.ColorFormat();

        // cell color formatting --> https://developers.google.com/chart/interactive/docs/reference#colorformatter
        dx = 1 / (colormapJet.length - 1);
        for (var i = 0; i <= colormapJet.length - 1; i++) {
            formatterColor.addRange(i * dx, (i + 1) * dx, 'gray', colormapJet[i])
        }

        populateFileDropDownMenu();
    })
}
//================== GOOGLE CHARTS LOADING (end) ==================//


//================== FIREBASE STORAGE STUFF ==================//
async function getFileListRecursiveFirebase(dir,ext){
	var fileList = await storage.ref().child(dir).listAll()

    //only keep files within last 2 years
    yr = new Date().getYear() + 1900

	var files = []
	for (const item of fileList.prefixes){
		var subfileList = await getFileListRecursiveFirebase(dir + item.name + '/',ext)
		files = [...files, ...subfileList]
	}
	for (i=0; i<=fileList.items.length-1; i++){
		if (typeof(ext) == 'string'){
			if (fileList.items[i].name.endsWith(ext)){
				files.push({fullpath: fileList.items[i].fullPath, name: fileList.items[i].name})
			} //if correct file extension
			else {
				// file does not have requested extension
			}
		}
		else if (fileList.items[i].name.slice(0,4) >= yr-1){
            files.push({fullpath: fileList.items[i].fullPath, name: fileList.items[i].name})
		}//IF file extension required
	}
	return files
}//FUNCTION getFileListRecursiveFirebase -- recursviely accumulate files from subfolders (if any)


async function populateFileDropDownMenu(){
    try {
        var filelist = await getFileListRecursiveFirebase(file.dir)

// // sort by value
// items.sort(function (a, b) {
//   return a.value - b.value;
// });

// sort descending by name
filelist.sort(function(a, b) {
  var nameA = a.name.toUpperCase(); // ignore upper and lowercase
  var nameB = b.name.toUpperCase(); // ignore upper and lowercase
  if (nameA > nameB) {
    return -1;
  }
  if (nameA < nameB) {
    return 1;
  }

  // names must be equal
  return 0;
});

// for (var i=0; i<=filelist.length-1; i++){
//     if (filelist[i].name.includes('Youno')){
//         filelist[i] = filelist[9]
//     }
// }

        file.filelist = filelist
        for (var i=0; i<=filelist.length-1; i++){
            //add to menu as option
            var opt = document.createElement('option')
            opt.value = i
            opt.innerHTML = filelist[i].name
            menuobj.appendChild(opt)              
        } //for i files
        file.name = file.filelist[0].fullpath
        file.filehasChanged = true
        loadDatafromFirebase(file.name)
    }
    catch (error) {
        console.error(error)
    }
}//FUNCTION populateFileDropDownMenu

// Asynchronous: Check for file updates
async function checkFileStatusFirebase() {
    try{
        var filemeta = await storage.ref().child(file.name).getMetadata()

        if (file.rev != filemeta.generation) {
            file.rev = filemeta.generation
            file.dateSaved = new Date(filemeta.updated)
            file.datahasChanged = true
            console.log('file was updated rev=' + file.rev)
        } else {
            file.datahasChanged = false
        } //if file.rev

        if (file.filehasChanged == true || file.datahasChanged == true) {
            loadDatafromFirebase(file.name)
        } else {
            setTimeout(function() {
                checkFileStatusFirebase()
            }, 1000)
        } //if filehasChanged
    }
    catch (error) {
        console.error(error)
    } //try
    return false
}//FUNCTION checkFileStatusFirebase

//------------- LOAD JSON TEXT --------------//
async function loadDatafromFirebase(textfile_path){
    try{
	    var textfileRef = storage.ref().child(textfile_path)
		url = await textfileRef.getDownloadURL()
		response = await fetch(url)
		var datajson = await response.json()

	    if (Array.isArray(datajson)) {
	        file.data = {};
	        for (var elem = 0; elem < datajson.length; elem++) {
	            for (var prop in datajson[elem]) {
	                file.data[prop] = datajson[elem][prop]
	            } //for property
	        } //for array elements

	        //Remove array nesting
	        file.data.FixationXYT = removeNesting(file.data.FixationXYT)
	        file.data.ResponseXYT = removeNesting(file.data.ResponseXYT)
	        file.data.Test = removeNesting(file.data.Test)
	    }//IF old array format
	    else {
	        file.data = {}
	        for (p in datajson){
	            for (q in datajson[p]){
	                file.data[q] = datajson[p][q]
	            }//for q properties
	        }//for p param objects
	    }//ELSE new object format

	    var filemeta = await storage.ref().child(textfile_path).getMetadata()
	    console.log("success: loaded file size " + filemeta.size/1000 + ' kb');
	    file.rev = filemeta.generation
	    file.dateSaved = new Date(filemeta.updated)

        // Trim RFID
        file.data.CurrentDate = new Date(file.data.CurrentDate).valueOf() //convert to number

		if (file.filehasChanged == true) {
			initializeChartData()
		} else if (file.datahasChanged == true) {
			updatePlots()
		}
	}//TRY
    catch (error) {
        console.error(error)
    }//CATCH
    return false
}//FUNCTION loadDatafromFirebase
//================== FIREBASE STORAGE STUFF (end) ==================//

//================== DATA HANDLING ==================//
// Synchronous: Initialize chart data matrices
function initializeChartData() {
    dataPerformance.removeRows(0,dataPerformance.getNumberOfRows());
    dataPerformance.removeColumns(0,dataPerformance.getNumberOfColumns());
    dataCumulative.removeRows(0, dataCumulative.getNumberOfRows());
    dataCumulative.removeColumns(0, dataCumulative.getNumberOfColumns());
    dataXYPos.removeRows(0, dataXYPos.getNumberOfRows());
    dataXYPos.removeColumns(0, dataXYPos.getNumberOfColumns());
    dataReactionTime.removeRows(0, dataReactionTime.getNumberOfRows());
    dataReactionTime.removeColumns(0, dataReactionTime.getNumberOfColumns());
    dataReward.removeRows(0, dataReward.getNumberOfRows());
    dataReward.removeColumns(0, dataReward.getNumberOfColumns());
    dataChoice.removeRows(0, dataChoice.getNumberOfRows());
    dataChoice.removeColumns(0, dataChoice.getNumberOfColumns());
    dataObjPerf.removeRows(0,dataObjPerf.getNumberOfRows());
    dataObjPerf.removeColumns(0,dataObjPerf.getNumberOfColumns());
    dataWeight.removeColumns(0,dataWeight.getNumberOfColumns());
    dataWeight.removeRows(0,dataWeight.getNumberOfRows());

    dataPerformance.addColumn('number','currentTrial')
    dataPerformance.addColumn('number','current')
    dataPerformance.addColumn('number','100trialsAvg')

    dataCumulative.addColumn('datetime', 'time')
    dataCumulative.addColumn('number', 'Trials')
    dataCumulative.addColumn('number', 'Performance')
    dataCumulative.addColumn('number', 'RFID')
    dataCumulative.addColumn('number', 'Weight')

    dataWeight.addColumn('datetime','time')
    dataWeight.addColumn('number','WeightReads')

    dataReactionTime.addColumn('string','success')
    dataReactionTime.addColumn('number','durationMS')

	//dataXYPos for 2 test choices
	// 0: x
	// 1: y fix (box)
	// 2: y sample (box)
	// 3: y test1 (box)
	// 4: y test2 (box)
	// 3: y same (box)
	// 4: y different (box)
	// 5: y Fix_reward (dots)
	// 6: y Fix_punish (dots)
	// 7: y Target_reward (dots)
	// 8: y Target_punish (dots)
    dataXYPos.addColumn('number', 'xpos')
    dataXYPos.addColumn('number','Fixation')
    dataXYPos.addColumn('number','Sample')  
    if (file.data.SameDifferent <= 0){
	    for (var i = 0; i<=file.data.TestGridIndex.length-1;i++){
	        dataXYPos.addColumn('number', 'Test' + (i+1))
	    }    	
    }//IF !SD
    else if (file.data.SameDifferent > 0){
        dataXYPos.addColumn('number', 'Same')
        dataXYPos.addColumn('number', 'Different')
    }//ELSEIF SD

    dataXYPos.addColumn('number', 'Fix_Reward')
    dataXYPos.addColumn('number', 'Fix_Punish')
    dataXYPos.addColumn('number', 'Target_Reward')
    dataXYPos.addColumn('number','Target_Punish')

    dataReward.addColumn('string', 'reward size')
    dataReward.addColumn('number', 'nrewards')

    dataChoice.addColumn('string', 'choice')
    dataChoice.addColumn('number', '# of responses')

    dataObjPerf.addColumn('string','object')
    dataObjPerf.addColumn('number','performance')

    updatePlots()
    file.filehasChanged = false
}//FUNCTION initializeChartData()

// Synchronous
function toVitals() {
    vitals.subject = file.data.Subject;
    vitals.trials = file.data.Response.length;
    vitals.time = Math.round(Math.round(file.data.StartTime[vitals.trials - 1] - file.data.StartTime[0]) / 60000);
    //convert msec to minutes

    //RFID
    if (typeof(file.data.RFIDTag) != "undefined" && typeof(file.data.RFIDTime) != "undefined"){
        vitals.RFIDtag = file.data.RFIDTag[file.data.RFIDTag.length - 1];
        vitals.RFIDtime = Math.round(Math.round(file.data.RFIDTime[file.data.RFIDTime.length - 1] - file.data.StartTime[0]) / 60000);
        //convert millisecond to minutes
    }//IF old data format
    else if (typeof(file.data.RFIDTag) != "undefined" && Object.keys(file.data.RFIDTag).length>0){
        vitals.RFIDtag = file.data.RFIDTag[Object.keys(file.data.RFIDTag).length - 1][2];
        // vitals.RFIDtime = Math.round(file.data.RFIDTag[Object.keys(file.data.RFIDTag).length - 1][1] / 60000); //convert millisecond to minutes
        vitals.RFIDtime = new Date(file.data.RFIDTag[Object.keys(file.data.RFIDTag).length - 1][1]).toLocaleTimeString('en-US')
    }//ELSEIF new data format
    else {
        vitals.RFIDtag = null
        vitals.RFIDtime = null
    }

    //WEIGHT
    if (typeof(file.data.Weight) != "undefined" && file.data.Weight.length>1 && typeof(file.data.WeightTime!="undefined")) {
        vitals.MaxWeight = file.data.Weight.reduce(function(a, b) {
            return Math.max(a, b);
        });
        vitals.LastWeightTime = Math.round(Math.round(file.data.WeightTime[file.data.WeightTime.length - 1] - file.data.StartTime[0]) / 60000);
        //convert millisecond to minutes
    }//IF old data format
    else if (typeof(file.data.Weight) != "undefined" && Object.keys(file.data.Weight).length > 0){
        //XX not implemented for new data format
        vitals.MaxWeight = file.data.Weight.reduce(function(a, b) {
            return Math.max(a[2], b[2]);
        });        
        vitals.LastWeightTime = Math.round(Math.round(file.data.Weight[Object.keys(file.data.Weight).length - 1][1] - file.data.StartTime[0]) / 60000);
        //convert millisecond to minutes
    }//ELSEIF new data format
    else {
        vitals.MaxWeight = null
        vitals.LastWeightTime = null
    }

    vitals["automator"]
    if (typeof(file.data.Automator) != "undefined") {
        vitals.automator = file.data.Automator
    } else {
        vitals.automator = null
    }

    if (typeof(file.data.CurrentAutomatorStage) != "undefined") {
        vitals.currentautomatorstage = file.data.CurrentAutomatorStage
    } else {
        vitals.currentautomatorstage = null
    }

    if (typeof(file.data.CurrentAutomatorStageName) != "undefined") {
        vitals.currentautomatorstagename = file.data.CurrentAutomatorStageName
    } else {
        vitals.currentautomatorstagename = null
    }

    //BATTERY
    if (typeof(file.data.BatteryLDT) != "undefined" && file.data.BatteryLDT.length != 0) {
        vitals.batteryleft = Math.round(file.data.BatteryLDT[file.data.BatteryLDT.length - 1][0] * 100);
        vitals.batteryused = Math.round(file.data.BatteryLDT[0][0] * 100 - vitals.batteryleft);
    }//IF old data format
    else if (typeof(file.data.Battery) != "undefined" && Object.keys(file.data.Battery).length > 0){
        vitals.batteryleft = Math.round(file.data.Battery[Object.keys(file.data.Battery).length - 1][2] * 100);
        vitals.batteryused = Math.round(file.data.Battery[0][2] * 100 - vitals.batteryleft);
    }//ELSEIF new data format    
    else {
        vitals.batteryleft = null;
        vitals.batteryused = null;
    }
    var ncorrect = 0;
    for (var i = 0; i <= file.data.CorrectItem.length - 1; i++) {
        if (file.data.CorrectItem[i] == file.data.Response[i]) {
            ncorrect++;
        }
    }
    vitals.ncorrect = ncorrect; 
    vitals.pctcorrect = Math.round(100 * ncorrect / file.data.Response.length);

    if (typeof(file.data.NReward) != "undefined") {
        vitals.nrewards = file.data.NReward.reduce(function(a, b) {
            return a + b;
        }, 0);
    }

    vitals.rewardestimate = 0;
    if (typeof(file.data.RewardPer1000Trials) != "undefined") {
        vitals.rewardestimate = Math.round(file.data.RewardPer1000Trials * vitals.nrewards / 1000);
    }
}//FUNCTION toVitals()

// Synchronous
function toPerformanceData() {
    dataPerformance.removeRows(0,dataPerformance.getNumberOfRows());
    dataCumulative.removeRows(0,dataCumulative.getNumberOfRows());
    dataReactionTime.removeRows(0,dataReactionTime.getNumberOfRows());
    dataXYPos.removeRows(0,dataXYPos.getNumberOfRows());

    //Create the data table
    var xdata = []
    var ydata = []
    var ydata_5 = []
    var ydata_100 = []
    var ntotal = []
    var ncorrect = []
    var tcurrent = []
    var nRFID = []
    var nWeight = []
    var xpos = []
    var ypos = []
    var touchevent = []
    var rt = []

    for (var i = 0; i <= file.data.CorrectItem.length - 1; i++) {
        if (file.data.CorrectItem[i] == file.data.Response[i]) {
            ydata[i] = 1;
        }
        else {
            ydata[i] = 0;
        }
        xdata[i] = i;

        //Cumulative trials & correct trials
        ntotal[i] = xdata.length
        if (i > 0) {
            ncorrect[i] = ncorrect[i - 1] + ydata[i]
        } else if (i == 0) {
            ncorrect[i] = ydata[i]
        }
    }//FOR i trials

//------ Reaction Time
    for (var i=0; i<=file.data.NReward.length-1; i++){
        if (file.data.RewardStage==0){
            //file.data.StartTime & file.data.FixationXYT
            rt[i] = file.data.FixationXYT[2][i] - file.data.StartTime[i]
            dataReactionTime.addRows([[ file.data.FixationTouchEvent[i], rt[i] ]])
        }//IF RewardStage==0
        else if (file.data.NRSVP > 0){
            // file.data.SampleStartTime && file.data.SampleFixationXYT
            rt[i] = file.data.SampleFixationXYT[2][i] - file.data.SampleStartTime[i]
            dataReactionTime.addRows([[ file.data.SampleFixationTouchEvent[i], rt[i] ]])
        }
        else {
            // file.data.SampleStartTime && file.data.ResponseXYT
            rt[i] = file.data.ResponseXYT[2][i] - file.data.SampleStartTime[i]
            if (file.data.Response[i] == -1){
                dataReactionTime.addRows([[ "timeout", file.data.ChoiceTimeOut ]])
            }//IF choiceTimeOut
            else if (file.data.CorrectItem[i] == file.data.Response[i]){
                dataReactionTime.addRows([[ "correct", rt[i] ]])
            }//IF correct
            else{
                dataReactionTime.addRows([[ "wrong", rt[i] ]])
            }
        }
    }//FOR i NReward

console.log(rt)
//------ Touch XY
    // Store fixation in odd indices and choice in even
    // All touchevents. touchevent has a length that is twice the length of file.data.FixationXYT or file.data.ResponseXYT 
    if (typeof file.data.ResponseXYT != "undefined" && Object.keys(file.data.ResponseXYT).length > 0 && file.data.ResponseXYT[0].length > 0) {
        for (var i = 0; i <= file.data.FixationXYT[0].length * 2 - 1; i += 2) {
            touchevent[i]=[]
            touchevent[i+1]=[]
            touchevent[i][0] = file.data.FixationXYT[0][i / 2]
            touchevent[i + 1][0] = file.data.ResponseXYT[0][i / 2]
            touchevent[i][1] = file.data.FixationXYT[1][i / 2]
            touchevent[i + 1][1] = file.data.ResponseXYT[1][i / 2]
        }//FOR
    }//IF ResponseXYT
    else{
        for (var i = 0; i <= file.data.FixationXYT[0].length * 2 - 1; i += 2){
            touchevent[i]=[]
            touchevent[i+1]=[]
            touchevent[i][0] = file.data.FixationXYT[0][i / 2]
            touchevent[i + 1][0] = file.data.FixationXYT[0][i / 2]
            touchevent[i][1] = file.data.FixationXYT[1][i / 2]
            touchevent[i + 1][1] = file.data.FixationXYT[1][i / 2]
        }//FOR i fixations
    }//ELSE !ResponseXYT

    nColumn = dataXYPos.getNumberOfColumns()

    //Sample & Test Boxes -- Draw them as a bounding box in the touch plot
    if (file.data.SampleScenes[0].IMAGES.imageidx.length > 0){
		if (Array.isArray(file.data.SampleScenes[0].IMAGES.sizeInches)) {
	    	samplewidth = Math.max(...file.data.SampleScenes[0].IMAGES.sizeInches) * file.data.ViewportPPI			
		}
		else{
			console.log("! array, please fix scene file")
    		samplewidth = file.data.SampleScenes[0].IMAGES.sizeInches * file.data.ViewportPPI	
  		}
    }//IF 2D bkgd image
    else{
	    samplewidth = Math.max(...file.data.SampleScenes[0].OBJECTS[Object.keys(file.data.SampleScenes[0].OBJECTS)[0]].sizeInches) * file.data.ViewportPPI
    }//ELSE 3D size

    if (file.data.TestScenes[0].IMAGES.imageidx.length > 0) {
		if (Array.isArray(file.data.TestScenes[0].IMAGES.sizeInches)){
	    	testwidth = Math.max(...file.data.TestScenes[0].IMAGES.sizeInches) * file.data.ViewportPPI			
		}
		else{
			console.log("! array, please fix scene file")
    		testwidth = file.data.TestScenes[0].IMAGES.sizeInches * file.data.ViewportPPI
  		}
    }//IF 2D bkgd image
    else{
	    testwidth = Math.max(...file.data.TestScenes[0].OBJECTS[Object.keys(file.data.TestScenes[0].OBJECTS)[0]].sizeInches) * file.data.ViewportPPI
    }//ELSE 3D size
    sampleheight = samplewidth
    testheight = testwidth

    //Fixation & Choice Boxes
    if (file.data.FixationUsesSample <= 0){
	    fixationwidth = file.data.FixationSizeInches * file.data.ViewportPPI
    }//IF !sample
    else{
    	fixationwidth = samplewidth
    }//ELSE sample
	fixationheight = fixationwidth

    if (typeof(file.data.SameDifferent) != "undefined" && file.data.SameDifferent > 0){
        choicewidth = file.data.ChoiceSizeInches * file.data.ViewportPPI
        choiceheight = file.data.ChoiceSizeInches * file.data.ViewportPPI
    }  

    if (typeof(file.data.NRSVP) != "undefined" && file.data.NRSVP > 0){
    	testwidth = file.data.SampleFixationSizeInches * file.data.ViewportPPI
    }
    testheight = testwidth

    
    var ndisplayelements = 0

//NOTE for positioning elements: grid x,y is offset || fixation&response x,y is not

    //FIXATION
    ndisplayelements++
	fixation_xcoord = file.data.XGridCenter[ Math.max(...file.data.FixationGridIndex)]
	fixation_ycoord = file.data.ViewportPixels[1] - (file.data.YGridCenter[Math.max(...file.data.FixationGridIndex)] + file.data.offsettop)

    var  arr = new Array(nColumn)
    arr[0] = fixation_xcoord-fixationwidth/2
    arr[ndisplayelements] = fixation_ycoord-fixationheight/2
    dataXYPos.addRows([arr])

    arr[0] = fixation_xcoord+fixationwidth/2
    arr[ndisplayelements] = fixation_ycoord-fixationheight/2
    dataXYPos.addRows([arr])

    arr[0] = fixation_xcoord+fixationwidth/2
    arr[ndisplayelements] = fixation_ycoord+fixationheight/2
    dataXYPos.addRows([arr])

    arr[0] = fixation_xcoord-fixationwidth/2
    arr[ndisplayelements] = fixation_ycoord+fixationheight/2
    dataXYPos.addRows([arr])

    arr[0] = fixation_xcoord-fixationwidth/2
    arr[ndisplayelements] = fixation_ycoord-fixationheight/2
    dataXYPos.addRows([arr])

    //SAMPLE
    ndisplayelements++
    if (file.data.RewardStage > 0){
	    sample_xcoord = file.data.XGridCenter[Math.max(...file.data.SampleGridIndex)]
    	sample_ycoord = file.data.ViewportPixels[1] - (file.data.YGridCenter[Math.max(...file.data.SampleGridIndex)] + file.data.offsettop)
    }
    else {
    	sample_xcoord = fixation_xcoord
    	sample_ycoord = fixation_ycoord
    }

    var  arr = new Array(nColumn)
    arr[0] = sample_xcoord-samplewidth/2
    arr[ndisplayelements] = sample_ycoord-sampleheight/2
    dataXYPos.addRows([arr])

    arr[0] = sample_xcoord+samplewidth/2
    arr[ndisplayelements] = sample_ycoord-sampleheight/2
    dataXYPos.addRows([arr])

    arr[0] = sample_xcoord+samplewidth/2
    arr[ndisplayelements] = sample_ycoord+sampleheight/2
    dataXYPos.addRows([arr])

    arr[0] = sample_xcoord-samplewidth/2
    arr[ndisplayelements] = sample_ycoord+sampleheight/2
    dataXYPos.addRows([arr])

    arr[0] = sample_xcoord-samplewidth/2
    arr[ndisplayelements] = sample_ycoord-sampleheight/2
    dataXYPos.addRows([arr])

    //TEST
    var test_xcoord = []
    var test_ycoord = []
    if (file.data.RewardStage != 0 ){
        for (var i =0; i<=file.data.TestGridIndex.length-1; i++){

            if ( (file.data.SameDifferent > 0 || file.data.NRSVP > 0) ){
                break
            }//IF same-different, only show first test

            ndisplayelements++
            var arr = new Array(nColumn)

            if (file.data.NRSVP>0){
	            test_xcoord[i] = file.data.XGridCenter[Math.max(...file.data.SampleGridIndex)]
    	        test_ycoord[i] = file.data.ViewportPixels[1]- (file.data.YGridCenter[Math.max(...file.data.SampleGridIndex)] + file.data.offsettop)
            }
            else{
	            test_xcoord[i] = file.data.XGridCenter[file.data.TestGridIndex[i]]
    	        test_ycoord[i] = file.data.ViewportPixels[1]- (file.data.YGridCenter[file.data.TestGridIndex[i]] + file.data.offsettop)
            }

            arr[0] = test_xcoord[i]-testwidth/2
            arr[ndisplayelements] = test_ycoord[i]-testheight/2
            dataXYPos.addRows([arr])

            arr[0] = test_xcoord[i]+testwidth/2
            arr[ndisplayelements] = test_ycoord[i]-testheight/2
            dataXYPos.addRows([arr])

            arr[0] = test_xcoord[i]+testwidth/2
            arr[ndisplayelements] = test_ycoord[i]+testheight/2
            dataXYPos.addRows([arr])

            arr[0] = test_xcoord[i]-testwidth/2
            arr[ndisplayelements] = test_ycoord[i]+testheight/2
            dataXYPos.addRows([arr])

            arr[0] = test_xcoord[i]-testwidth/2
            arr[ndisplayelements] = test_ycoord[i]-testheight/2
            dataXYPos.addRows([arr])
        } //for n-way
    } //if rewardstage != 0

    //CHOICE
    var choice_xcoord = []
    var choice_ycoord = []
    if (file.data.RewardStage != 0 && file.data.SameDifferent > 0){
        for (var i =0; i<=file.data.ChoiceGridIndex.length-1; i++){
            ndisplayelements++
            var arr = new Array(nColumn)
            choice_xcoord[i] = file.data.XGridCenter[file.data.ChoiceGridIndex[i]]
            choice_ycoord[i] = file.data.ViewportPixels[1]-(file.data.YGridCenter[file.data.ChoiceGridIndex[i]]+file.data.offsettop)

            arr[0] = choice_xcoord[i]-choicewidth/2
            arr[ndisplayelements] = choice_ycoord[i]-choiceheight/2
            dataXYPos.addRows([arr])

            arr[0] = choice_xcoord[i]+choicewidth/2
            arr[ndisplayelements] = choice_ycoord[i]-choiceheight/2
            dataXYPos.addRows([arr])

            arr[0] = choice_xcoord[i]+choicewidth/2
            arr[ndisplayelements] = choice_ycoord[i]+choiceheight/2
            dataXYPos.addRows([arr])

            arr[0] = choice_xcoord[i]-choicewidth/2
            arr[ndisplayelements] = choice_ycoord[i]+choiceheight/2
            dataXYPos.addRows([arr])

            arr[0] = choice_xcoord[i]-choicewidth/2
            arr[ndisplayelements] = choice_ycoord[i]-choiceheight/2
            dataXYPos.addRows([arr])
        }//FOR n-way
    }//IF rewardstage != 0    

    var xpos_Fix = []
    var ypos_Fix = []
    var xpos_T = []
    var ypos_T = []
    var nTarget = [0,0]
    
    for (var i = 0; i <= touchevent.length - 1; i++) {
        xpos = touchevent[i][0]
        ypos = file.data.ViewportPixels[1]-touchevent[i][1]
        
        var ydata_index = []
        if (i % 2 == 0) {
            ydata_index = i / 2
        } else {
            ydata_index = (i - 1) / 2
        }

        if (xpos != -1) {
            var arr = new Array(nColumn)
            arr[0] = xpos 
            if (i % 2 == 0){ //if even (fixation)
                xpos_Fix.push(xpos)
                ypos_Fix.push(ypos)
                if (ydata[ydata_index]==1){
                //Fixation and Hit
                arr[ndisplayelements+1] = ypos 
                dataXYPos.addRows([arr])
                } else{
               //Fixation and Missed
                arr[ndisplayelements+2] = ypos 
                dataXYPos.addRows([arr])
                }
            } else { //if odd (choice)
                var xpos_T_arr = Array.apply(null, Array(file.data.TestGridIndex.length)).map(Number.prototype.valueOf, 0);
                var ypos_T_arr = Array.apply(null, Array(file.data.TestGridIndex.length)).map(Number.prototype.valueOf, 0);
                for (var j = 0; j<=file.data.TestGridIndex.length-1; j++){  //different targets 
                    
                    if (file.data.Response[ydata_index] == j){
                        xpos_T_arr[j] = xpos
                        ypos_T_arr[j] = ypos
                        nTarget[j]++
                    }
                    xpos_T.push(xpos_T_arr)  
                    ypos_T.push(ypos_T_arr)  
                }

                if (ydata[ydata_index]==1){ //Target and hit
                    arr[ndisplayelements+3] = ypos
                    dataXYPos.addRows([arr])

                } else{ //target and Missed
                    arr[ndisplayelements+4] = ypos 
                    dataXYPos.addRows([arr])
                } //if
            }// if even else odd
        } // if xpos

        mean_xpos_Fix = xpos_Fix.reduce(function(a,b){return a+b},0)/xpos_Fix.length
        mean_ypos_Fix = ypos_Fix.reduce(function(a,b){return a+b},0)/ypos_Fix.length
        dist_xpos_Fix = xpos_Fix.map(function(a){return Math.pow(Math.abs(a-mean_xpos_Fix),2)})
        dist_ypos_Fix = ypos_Fix.map(function(a){return Math.pow(Math.abs(a-mean_ypos_Fix),2)})
        std_Fix = dist_xpos_Fix.map(function(a,i){return Math.sqrt(a+dist_ypos_Fix[i])}).reduce(function(a,b){return a+b},0)/dist_xpos_Fix.length
        vitals.std_Fix = std_Fix            

        var std_T = []
        for (var j=0; j<=file.data.TestGridIndex.length-1;j++){                 
             all_xpos_T = xpos_T.map(function(a){return a[j]}).filter(function(a){return a!=0})
             mean_xpos_T = all_xpos_T.reduce(function(a,b){return a+b},0)/all_xpos_T.length 
             dist_xpos_T = all_xpos_T.map(function(a){return Math.pow(Math.abs(a-mean_xpos_T),2)})
             all_ypos_T = ypos_T.map(function(a){return a[j]}).filter(function(a){return a!=0})  
             mean_ypos_T = all_ypos_T.reduce(function(a,b){return a+b},0)/all_ypos_T.length
             dist_ypos_T = all_ypos_T.map(function(a){return Math.pow(Math.abs(a-mean_ypos_T),2)})
             std_T[j]= dist_xpos_T.map(function(a,i){return Math.sqrt(a+dist_ypos_T[i])}).reduce(function(a,b){return a+b},0)/all_xpos_T.length
        } //for j test choices
        vitals.std_T = std_T
        console.log('vitals.stdevTest:', vitals.std_T);
    } //for i touch events   

    ydata_5 = smooth(ydata,5);
    ydata_100 = smooth(ydata,100);
    
//Referencing to time file was last written & time of last trial rather than to file start.
    //Done because file can be changed on the fly which changes file start relative to performance.now()
    if (typeof file.data.ResponseXYT === 'undefined' 
        || Object.keys(file.data.ResponseXYT).length < 1 
        || typeof file.data.ResponseXYT[2][file.data.ResponseXYT[2].length - 1] === 'undefined')
    {
        var tend = file.data.FixationXYT[2][file.data.FixationXYT[2].length - 1]
    } else {
        var tend = file.data.ResponseXYT[2][file.data.ResponseXYT[2].length - 1]
    }

//------- RFID
    var ntrials = ydata.length
    var nreads = Object.keys(file.data.RFIDTag).length
    nRFID = Array(ntrials).fill(0)
    vitals.tagcount = {}

    for (i=0; i<=nreads-1; i++){
        if ( typeof(vitals.tagcount[ file.data.RFIDTag[i][2] ]) == "undefined"){
            vitals.tagcount[ file.data.RFIDTag[i][2] ] = 0
        }
        vitals.tagcount[ file.data.RFIDTag[i][2] ]++

        nRFID[ file.data.RFIDTag[i][0] ]++
    }//FOR i reads
	
	//Accumulate
	for (i=1; i<=nRFID.length-1; i++){
		nRFID[i] = nRFID[i] + nRFID[i-1]
	}
    

//------ WEIGHT
    for (var i = 0; i <= ydata.length - 1; i++){
        var tfix = file.data.FixationXYT[2][i]//in milliseconds
        if (tfix < 0){
            continue
        }

        var t = new Date(file.dateSaved)
        t.setTime(t.getTime() - (tend - tfix))

        var minIndex = 0;
        if (typeof(file.data.WeightTime) != "undefined"){
            for (var j = 0; j <= file.data.WeightTime.length - 1; j++) {

                if (Math.abs(file.data.WeightTime[j] - tfix) < Math.abs(file.data.WeightTime[minIndex]-tfix)) {
                    minIndex = j;
                }
            }//FOR j weight reads
        }
        nWeight[i] = minIndex

        dataPerformance.addRows([[xdata[i], ydata_5[i],ydata_100[i]]])
        dataCumulative.addRows([[new Date(t), ntotal[i], ncorrect[i], nRFID[i], nWeight[i]]])
    }//FOR i trials

    formatterDate.format(dataCumulative, 0)
}//FUNCTION toPerformanceData()

//Synchronous
function toWeightData(){
    dataWeight.removeRows(0,dataWeight.getNumberOfRows());
    
    if (typeof(file.data.WeightTime) != null && typeof(file.data.WeightTime) != "undefined"){

    for (var i=0; i<=file.data.WeightTime.length-1;i++){
        var tt = new Date(file.data.CurrentDate)
        tt.setTime(tt.getTime()-file.data.StartTime[0]+file.data.WeightTime[i])
        dataWeight.addRows([[new Date(tt),file.data.Weight[i]]])
    }
    
}
    formatterDate.format(dataWeight, 0)
}//FUNCTION toWeightData

//Synchronous
function toObjPerfData(){

    dataObjPerf.removeRows(0,dataObjPerf.getNumberOfRows());
    
    if (file.data.RewardStage == 1){
        var sampleobj = []
        if (file.data.NTrialsPerBagBlock >5000){ //detection task 
            sampleobj[0] = file.data.ImageBagsSample[0].split("/")[5];
            dataObjPerf.addRow([sampleobj[0],0]);
            var sampleobj_length = 1;
        }
        else{
            var sampleobj = []
    
            for (var i=0; i<=file.data.ImageBagsSample.length-1;i++){
                sampleobj[i] = file.data.ImageBagsSample[i].split("/")[5];
                dataObjPerf.addRow([sampleobj[i],0]);
                var sampleobj_length = sampleobj.length
            } //FOR i sample bags
        } //IF ntrialsperbagblock

        var NdiffObjPerf = Array.apply(null, Array(sampleobj_length)).map(Number.prototype.valueOf, 0);
        var NdiffObj = Array.apply(null, Array(sampleobj_length)).map(Number.prototype.valueOf, 0);
        for (var i = 0; i <= file.data.Sample[0].length - 1; i++) {
            for (var j = 0; j <= sampleobj_length - 1; j++) {
                if (file.data.SampleBagIdx[file.data.Sample[0][i]] == j){
                    NdiffObj[j]++
                    if (file.data.Response[i] == file.data.CorrectItem[i]){
                        NdiffObjPerf[j]++
                    } //IF correct
                }//IF sample was that object
                dataObjPerf.setValue(j, 1, NdiffObjPerf[j] / NdiffObj[j])
            }//FOR j sampleobj
        }//FOR i trials
    }//IF rewardstage==1
}//FUNCTION toObjPerfData

//Synchronous
function toChoiceData() {
     dataChoice.removeRows(0,dataChoice.getNumberOfRows());

    if (file.data.RewardStage !=0){ //Non-fixation task 
        var possibleResp = Array.apply(null,Array(file.data.ObjectGridIndex.length)).map(Number.prototype.valueOf,0);
       
        if (file.data.ObjectGridIndex.length !=0 && (file.data.NTrialsPerBagBlock == undefined || file.data.NTrialsPerBagBlock <1000)){ //Stimulus Response Task 
            let objgridindex = [...file.data.ObjectGridIndex]
            objgridindex.sort(function (a,b) {return a-b})
            var allind = []
            for (var i = 0; i<=objgridindex.length-1;i++){
                allind[i] = file.data.ObjectGridIndex.indexOf(objgridindex[i])
            }

            for (var i = 0; i <= objgridindex.length - 1; i++) {
                dataChoice.addRow([file.data.ImageBagsSample[allind[i]].split("/")[5],0]);
                possibleResp[i] = i
            }//FOR i objectgrid
        }else{
            for (var i = 0; i <= file.data.TestGridIndex.length - 1; i++) {
                dataChoice.addRow(['choice' + (i + 1), 0]);
                possibleResp[i] = i
            }//FOR i testgrid
        }//IF

        var NdiffChoice = Array.apply(null, Array(possibleResp.length)).map(Number.prototype.valueOf, 0);
        var NallChoice = 0

        for (var i = 0; i <= file.data.Response.length - 1; i++) {
            if (file.data.Response[i] != -1){
                NallChoice++
            }
            for (var j = 0; j <= possibleResp.length - 1; j++) {
                if (file.data.Response[i] == possibleResp[j] && file.data.Response[i]!=-1) {
                    NdiffChoice[j]++
                }
                dataChoice.setValue(j, 1, NdiffChoice[j] / NallChoice)
            }

        }
    }//IF RewardStage == 1
    else{ //Fixation Task 
        dataChoice.addRow(['outside Fix',0]);
        dataChoice.addRow(['inside Fix',0]);

        var NdiffChoice = Array.apply(null, Array(2)).map(Number.prototype.valueOf, 0);
        var NallChoice = 0
        var ydata = []

        for (var i = 0; i <= file.data.CorrectItem.length - 1; i++) {

            if (file.data.CorrectItem[i] == file.data.Response[i]) {
                ydata[i] = 1;
            } else {
                ydata[i] = 0;
            }
        }//FOR i correctItem

        for (var i = 0; i <= ydata.length - 1; i++) {
                NallChoice++

            for (var j=0;j<=1;j++){
                if (ydata[i]==j){
                    NdiffChoice[j]++
                }
                dataChoice.setValue(j,1,NdiffChoice[j]/NallChoice)
            }
        }//FOR i
    }//ELSE rewardstage==0
}//FUNCTION toChoiceData()
    

// Synchronous
function toRewardData() {
    dataReward.removeRows(0,dataReward.getNumberOfRows());
    var nrewardMax = []
    for (var i = 0; i <= file.data.NRewardMax; i++) {
        nrewardMax.push(i.toString())
    }

    nrewardMax.unshift('-1')

    for (var i = 0; i <= nrewardMax.length - 1; i++) {
        dataReward.addRow([nrewardMax[i], 0]);
    }

    var NdiffReward = Array.apply(null, Array(nrewardMax.length)).map(Number.prototype.valueOf, 0);

    for (var i = 0; i <= file.data.NReward.length - 1; i++) {
        if (file.data.Response[i] == -1){
                NdiffReward[0]++    //timeout trials 
                dataReward.setValue(0,1,NdiffReward[0]/file.data.NReward.length)
            }
        else{
            for (var j = 1; j <= nrewardMax.length - 1; j++) {
                if (file.data.NReward[i].toString() == nrewardMax[j]) {
                    NdiffReward[j]++
               }
               dataReward.setValue(j, 1, NdiffReward[j] / file.data.NReward.length)

            }
            
        }

    }
}//FUNCTION toRewardData()
//================== DATA HANDLING (end) ==================//

//================== PLOTTING ==================//
// Synchronous
function updatePlots() {
    toVitals();
    toPerformanceData();
    toWeightData();
    toObjPerfData();
    toChoiceData();
    toRewardData();
    addVitalsText();
    addTouchSDText();
    showTaskText();

    drawLine() //current
    drawArea()
    //cumulative
    drawWeight()
    drawObjPerfBar()
    drawScatter()
    drawReactionTimeHistogram()
    drawChoiceBar()
    drawReward()
    file.datahasChanged = false
    checkFileStatusFirebase();
}//FUNCTION updatePlots()

// Synchronous
function addVitalsText() {
    lineOptions.title =
    vitals.subject + ": " + vitals.pctcorrect + "% "
    + "(n=" + vitals.ncorrect + " out of " + vitals.trials + ", r=" + vitals.nrewards + "=" + vitals.rewardestimate + "mL, " + vitals.time + "min)     "
     + "\n RFID: " + vitals.RFIDtag + " (" + vitals.RFIDtime + ")"
   	 + "...."
     for (obj in vitals.tagcount){
        lineOptions.title = lineOptions.title + obj + ' n=' + vitals.tagcount[obj] + ', ' 
     }//FOR obj

     lineOptions.title = lineOptions.title
     + "\n Battery: " + vitals.batteryleft + "% (-" + vitals.batteryused + "%)  " 
     + "\n Last Trial: " + file.dateSaved.toLocaleTimeString('en-US')
    titleobj.innerHTML = vitals.subject;
}//FUNCTION addVitalsText()

//Synchronous
function addTouchSDText(){
    scatterOptions.title = "Touch Locations " + " -- standard dev: " 
                            + "\n Fixation: " + Math.round(vitals.std_Fix*10)/10 + " pixels"

    for (var i = 0; i<=vitals.std_T.length-1; i++){
        scatterOptions.title = scatterOptions.title + 
        "\n Target" + i + ": " + Math.round(vitals.std_T[i]*10)/10
    }
}//FUNCTION addVitalsText()

// Synchronous
function showTaskText(){
	//add object metadata
	var taskname = file.data.Task

	var textobj = document.getElementById("tasktext");
	textobj.innerHTML = 
	"<b>" + taskname + "</b>"
	+"<br> <b>Sample nouns:</b> " + file.data.SampleNouns + '  (' + file.data.SampleBagNames + ')'
	+ "<br> <b>Test nouns:</b> " + file.data.SampleNouns + '  (' + file.data.TestBagNames + ')'
	+ "<br>"
	+ "<br> Sample object models: " + file.data.SampleObjects
	+ "<br> Test object models: " + file.data.TestObjects
	+ "<br><br>"
	+ JSON.stringify(file.data, function(a, b) {
	return (Object.prototype.toString.call(b) === '[object Array]') ? JSON.stringify(b) : b;
	}, 4)
}//FUNCTION showTaskText()

//Synchronous
function drawLine(){
    var nrows = dataPerformance.getNumberOfRows()
    var sliderstate = livesliderTrial.getState()

    //updating slider
    if (file.datahasChanged == true && file.filehasChanged == false){
        if (nrows <= 100){
            // expand window size automatically up to 100
            sliderstate.range.start = 0
            sliderstate.range.end = nrows
        }
        else {
            //shift slider over
            dtrials = nrows - ntrials
            sliderstate.range.start = sliderstate.range.start + dtrials
            sliderstate.range.end = sliderstate.range.end + dtrials
        }
    }
    else if (file.filehasChanged == true){
        //shift slider to end
        dslider = 100
        sliderstate.range.start = nrows - dslider
        sliderstate.range.end = nrows
        if (sliderstate.range.start < 0){
            sliderstate.range.start = 0
        }
    }

    liveline.setOptions(lineOptions)

    //move slider which will drive replotting
    livesliderTrial.setState({'range': {'start': sliderstate.range.start,'end': sliderstate.range.end}})
    dashboard1.draw(dataPerformance)
    ntrials = nrows //new trial range
}//FUNCTION drawLine()

//Synchronous
function drawArea() {
    var sliderstate = livesliderTime.getState()

    var tmin = new Date(dataCumulative.getColumnRange(0).min)
    var tmax = new Date(dataCumulative.getColumnRange(0).max)

    var trange = tmax.getTime() - tmin.getTime()
    var onehr = 60 * 60 * 1000

    //updating slider
    if (file.datahasChanged == true && file.filehasChanged == false) {
        // if (trange < onehr){
        // expand window size automatically up to 100
        sliderstate.range.start = tmin
        sliderstate.range.end = tmax
        // }
        // else {
        //  //shift slider over
        //  var dt = tmax.getTime() - tlast.getTime()
        //  sliderstate.range.start.setTime(sliderstate.range.start.getTime() + dt)
        //  sliderstate.range.end.setTime(sliderstate.range.end.getTime() + dt)
        // }
    } else if (file.filehasChanged == true) {
        sliderstate.range.start = tmin
        sliderstate.range.end = tmax
        // //shift slider to end
        // sliderstate.range.start = new Date(tmax.getTime() - onehr)
        // sliderstate.range.end = tmax
        // if (sliderstate.range.start.getTime() < tmin.getTime()){
        //  sliderstate.range.start = new Date(tmin.getTime())
        // }
    }
    tlast = new Date(dataCumulative.getColumnRange(0).max)

    //move slider which will drive replotting
    livesliderTime.setState({
        'range': {
            'start': sliderstate.range.start,
            'end': sliderstate.range.end
        }
    })
    livearea.setOptions(areaOptions)
    dashboard2.draw(dataCumulative)
}//FUNCTION drawArea()

//Synchronous
function drawWeight() {
    liveweight.draw(dataWeight,weightOptions)
}//FUNCTION drawWeight()

//Synchronous
function drawObjPerfBar() {
    liveobjperf.draw(dataObjPerf, objPerfBarOptions)   
}//FUNCTION drawObjPerfBar

//Synchronous
function drawReactionTimeHistogram(){
    livereactiontime.draw(dataReactionTime, reactionTimeHistogramOptions)
}//FUNCTION drawReactionTimeHistogram

// Synchronous
function drawScatter() {
    scatterOptions.series = []
    for (var i=0; i<dataXYPos.getNumberOfColumns();i++){
        if (dataXYPos.getColumnLabel(i) == "Fixation"){
            scatterOptions.series[i-1] = {type:'line',color:'gray'} //,visibleInLegend: false}
        } //if fixation 
        else if (dataXYPos.getColumnLabel(i) == "Sample"){
            scatterOptions.series[i-1] = {type:'line',color:'black'} //,visibleInLegend: false}
        } // else if sample 
        else if (dataXYPos.getColumnLabel(i) == "Same"){
            scatterOptions.series[i-1] = {type:'line',color:'green'} //,visibleInLegend: false}
        } // else if same
        else if (dataXYPos.getColumnLabel(i) == "Different"){
            scatterOptions.series[i-1] = {type:'line',color:'red'} //,visibleInLegend: false}
        } // else if different
        else if (dataXYPos.getColumnLabel(i) == "Fix_Reward"){
            scatterOptions.series[i-1] = {color: 'blue'}
        } else if (dataXYPos.getColumnLabel(i) == "Fix_Punish"){
            scatterOptions.series[i-1] = {color: 'red'}
        } else if (dataXYPos.getColumnLabel(i) == "Target_Reward"){
            scatterOptions.series[i-1] = {color: 'green'}
        } else if (dataXYPos.getColumnLabel(i) == "Target_Punish"){
            scatterOptions.series[i-1] = {color: 'black'}
        }
        else if (dataXYPos.getColumnLabel(i).includes("Test")){
            scatterOptions.series[i-1] = {type:'line',color:'black'} //,visibleInLegend: false}
        } // else if test
    } //for i scatter plot elements
    scatterOptions.height = file.data.workspace[3]*file.data.CanvasRatio,
    scatterOptions.width = file.data.workspace[2]*file.data.CanvasRatio,
    scatterOptions.hAxis = {title: 'X position (pixels)',
    viewWindow: {
        min: 0, max: file.data.workspace[2]*file.data.CanvasRatio}
    },
    scatterOptions.vAxis = {title: 'Y position (pixels)', 
    viewWindow: {
        min: 0, max: file.data.workspace[3]*file.data.CanvasRatio}
    }
    livescatter.draw(dataXYPos, scatterOptions)
}//FUNCTION drawScatter()


//Synchronous
function drawChoiceBar() {
    livechoice.draw(dataChoice, choiceBarOptions)
}//FUNCTION drawChoiceBar()

//Synchronous
function drawReward() {
    livereward.draw(dataReward, rewardBarOptions)
}//FUNCTION drawReward()

//================== PLOTTING (end) ==================//
</script>
</head>
<body>
<h1>liveplot2_mkturk</h1>
<div id="filelist_div">
	<!--Pull down menu that will hold file list-->
	<select id="file_list"></select>
</div>

<div id="dashboard1_div">
	<div id="line_div"></div> <!--Div that will hold the line chart-->
	<div id="filtertrial_div"></div>
</div>

<div id="dashboard2_div">
	<div id="area_div"></div>
	<!--Div that will hold the area chart-->
	<div id="filtertime_div"></div>
</div>
<div id="scatter_div"></div> </div>
<div id='reactiontime_div'></div> </div>
<div id='choice_div'></div> </div>
<div id='objectPerf_div'></div> </div>
<div id='reward_div'></div></div>
<div id= 'weight_div'></div> </div>
<pre id="tasktext" style="position: absolute; left: 1px; width: 100%; font-size: 18px; color: black; font-family: 'Helvetica Neue', Helvetica, Arial, sans-serif; word-break: break-all;"></pre>
<script type="text/javascript">
var file = {
	dir: DATA_SAVEPATH, // from mkturk_installsettings.js
	list: [],
	filelist: [],
	name: "",
	data: null,
	ver: null,
	date: null,
	datahasChanged: false,
	filehasChanged: false,
};

var titleobj = document.getElementById("page_title");
var menuobj = document.getElementById("file_list");
menuobj.addEventListener("change", filelist_listener, false);

var vitals = {
	subject: null,
	pctcorrect: 0,
	trials: 0,
	time: 0,
	batteryleft: 0,
	batteryused: 0,
	rewardestimate: 0,
	automator: "",
	currentautomatorstage: 0,
	currentautomatorstagename: "",
	nrewards: 0,
	RFIDtag: "",
	RFIDtime: 0,
	tagcount: {},
}

var dataPerformance = null; 
var dataCumulative = null;
var dataReactionTime = null;
var dataXYPos = null;
var dataReward = null;
var dataChoice = null;
var dataObjPerf = null;
var dataWeight = null; 
var liveline = null;
var formatterDate = null; 
var formatterDigits = null;
var formatterColor = null;

var trialrange = [0, 0]

//================== AUTHENTICATE GOOGLE ==================//
// [START authstatelistener]
var provider = new firebase.auth.GoogleAuthProvider();
provider.addScope('https://www.googleapis.com/auth/contacts.readonly');
firebase.auth().getRedirectResult().then(function(result) {
  if (result.user) {
    // User just signed in. you can get the result.credential.
	console.log('Sign-In Redirect Result, USER ' + result.user.email + ' is signed in')
  }
  else if (firebase.auth().currentUser) {
    // User already signed in.
	console.log('Sign-In Redirect Result, USER ' + firebase.auth().currentUser.email + ' is signed in')
  }
  else {
    // No user signed in, update your UI, show the redirect sign-in screen.
	firebase.auth().signInWithRedirect(provider)
  }
});
//================== (end) AUTHENTICATE GOOGLE ==================//

loadGoogleCharts()
</script>
</body></html>