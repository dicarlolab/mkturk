(()=>{"use strict";var e={279:(e,t,a)=>{a.r(t)},652:(e,t,a)=>{Object.defineProperty(t,"__esModule",{value:!0}),t.Charts=void 0;const i=a(655).__importDefault(a(486)),s=a(593),l=["#00008F","#00009F","#0000AF","#0000BF","#0000CF","#0000DF","#0000EF","#0000FF","#0010FF","#0020FF","#0030FF","#0040FF","#0050FF","#0060FF","#0070FF","#0080FF","#008FFF","#009FFF","#00AFFF","#00BFFF","#00CFFF","#00DFFF","#00EFFF","#00FFFF","#10FFEF","#20FFDF","#30FFCF","#40FFBF","#50FFAF","#60FF9F","#70FF8F","#80FF80","#8FFF70","#9FFF60","#AFFF50","#BFFF40","#CFFF30","#DFFF20","#EFFF10","#FFFF00","#FFEF00","#FFDF00","#FFCF00","#FFBF00","#FFAF00","#FF9F00","#FF8F00","#FF8000","#FF7000","#FF6000","#FF5000","#FF4000","#FF3000","#FF2000","#FF1000","#FF0000","#EF0000","#DF0000","#CF0000","#BF0000","#AF0000","#9F0000","#8F0000","#800000"],r=new s.Utils;t.Charts=class{constructor(e){this.elemObject=e,this.realtimePlotActive=!1,this.setupCharts(),this.vitals={subject:null,pctCorrect:0,trials:0,time:0,batteryLeft:0,batteryUsed:0,rewardEstimate:0,automator:"",automatorStage:0,automatorStageName:"",numReward:0,rfidTag:"",rfidTime:0,tagCount:{}}}setupDataTables(){this.perfDataTable=new google.visualization.DataTable,this.cumulDataTable=new google.visualization.DataTable,this.xyPosDataTable=new google.visualization.DataTable,this.rxnTimeDataTable=new google.visualization.DataTable,this.rewardDataTable=new google.visualization.DataTable,this.choiceDataTable=new google.visualization.DataTable,this.objPerfDataTable=new google.visualization.DataTable,this.realtimeDataTable=new google.visualization.DataTable,this.rtData={}}async setupCharts(){await google.charts.load("current",{packages:["corechart","controls"]}),this.setupChartOptions(),this.setupDataTables(),this.perfDashboard=new google.visualization.Dashboard(this.elemObject.perfDiv),this.perfPlot=new google.visualization.ChartWrapper(this.perfPlotConfig),this.perfFilter=new google.visualization.ControlWrapper(this.perfFilterConfig),this.trialDashboard=new google.visualization.Dashboard(this.elemObject.trialDiv),this.trialPlot=new google.visualization.ChartWrapper(this.trialPlotConfig),this.trialFilter=new google.visualization.ControlWrapper(this.trialFilterConfig),this.perfDashboard.bind(this.perfFilter,this.perfPlot),this.trialDashboard.bind(this.trialFilter,this.trialPlot),this.screenPlot=new google.visualization.ComboChart(this.elemObject.screenPlot),this.rxnPlot=new google.visualization.Histogram(this.elemObject.rxnPlot),this.rewardPlot=new google.visualization.ColumnChart(this.elemObject.rewardPlot),this.choicePlot=new google.visualization.ColumnChart(this.elemObject.choicePlot),this.objPerfPlot=new google.visualization.ColumnChart(this.elemObject.objPerfPlot)}setupChartOptions(){this.perfPlotOptions={width:this.elemObject.perfPlot.clientWidth,height:this.elemObject.perfPlot.clientHeight,hAxis:{title:"Trial#"},vAxis:{title:"Correct (%)",viewWindow:{min:0,max:1}},animation:{duration:500,easing:"linear",startup:!0},series:{0:{color:"#43459d"},1:{color:"#e2431e"}}},this.perfPlotConfig={chartType:"LineChart",containerId:"performance-plot",options:this.perfPlotOptions},this.perfFilterOptions={filterColumnLabel:"currentTrial",ui:{chartType:"LineChart",chartOptions:{smooth:20,hAxis:{baselineColor:"none",title:"Trial#"},vAxis:{title:"%",viewWindow:{min:0,max:1}},width:this.elemObject.perfFilter.clientWidth,height:this.elemObject.perfFilter.clientHeight,animation:{duration:1e3,easing:"out"}},chartView:{columns:[0,1]},minRangeSize:2}},this.perfFilterConfig={controlType:"ChartRangeFilter",containerId:"performance-filter",state:{range:{start:0,end:100}},options:this.perfFilterOptions},this.trialPlotOptions={width:this.elemObject.trialPlot.clientWidth,height:this.elemObject.trialPlot.clientHeight,areaOpacity:.5,hAxis:{title:"Time (h) "},vAxes:{0:{title:"Trial count"},1:{title:"RFID"}},animation:{duration:500,easing:"linear",startup:!0},series:{0:{targetAxisIndex:0},1:{targetAxisIndex:0},2:{targetAxisIndex:1}}},this.trialPlotConfig={chartType:"AreaChart",containerId:"trial-plot",options:this.trialPlotOptions},this.trialFilterOptions={filterColumnLabel:"time",ui:{chartType:"LineChart",chartOptions:{hAxis:{baselineColor:"none",title:"Time"},vAxis:{title:"#"},width:this.elemObject.trialFilter.clientWidth,height:this.elemObject.trialFilter.clientHeight,animation:{duration:1e3,easing:"out"}}},chartView:{columns:[0,1]}},this.trialFilterConfig={controlType:"ChartRangeFilter",containerId:"trial-filter",state:{range:{start:0,end:100}},options:this.trialFilterOptions},this.screenPlotOptions={seriesType:"scatter",pointSize:1},this.rxnPlotOptions={width:this.elemObject.rxnPlot.clientWidth,height:this.elemObject.rxnPlot.clientHeight,title:"Reaction Time (ms)",animation:{duration:500,easing:"linear",startup:!0},legend:{position:"none"}},this.rewardPlotOptions={width:this.elemObject.rewardPlot.clientWidth,height:this.elemObject.rewardPlot.clientHeight,title:"Amount of Reward",hAxis:{title:"reward amount"},vAxis:{title:"counts",minValue:0,maxValue:1},legend:{position:"none"}},this.choicePlotOptions={width:this.elemObject.choicePlot.clientWidth,height:this.elemObject.choicePlot.clientHeight,hAxis:{title:"Choice"},vAxis:{title:"counts",minValue:0,maxValue:1},legend:{position:"none"}},this.objPerfPlotOptions={width:this.elemObject.objPerfPlot.clientWidth,height:this.elemObject.objPerfPlot.clientHeight,hAxis:{title:"Objects"},vAxis:{title:"counts",minValue:0,maxValue:1},title:"Object Performance",legend:{position:"none"}}}initializeChartData(e,t){if(this.perfDataTable.removeRows(0,this.perfDataTable.getNumberOfRows()),this.perfDataTable.removeColumns(0,this.perfDataTable.getNumberOfColumns()),this.cumulDataTable.removeRows(0,this.cumulDataTable.getNumberOfRows()),this.cumulDataTable.removeColumns(0,this.cumulDataTable.getNumberOfColumns()),this.xyPosDataTable.removeRows(0,this.xyPosDataTable.getNumberOfRows()),this.xyPosDataTable.removeColumns(0,this.xyPosDataTable.getNumberOfColumns()),this.realtimeDataTable.removeRows(0,this.realtimeDataTable.getNumberOfRows()),this.realtimeDataTable.removeColumns(0,this.realtimeDataTable.getNumberOfColumns()),this.realtimePlotActive=!1,this.realtimeRowDataAdded=!1,this.rtData.test=[],this.rtData.choice=[],this.rxnTimeDataTable.removeRows(0,this.rxnTimeDataTable.getNumberOfRows()),this.rxnTimeDataTable.removeColumns(0,this.rxnTimeDataTable.getNumberOfColumns()),this.rewardDataTable.removeRows(0,this.rewardDataTable.getNumberOfRows()),this.rewardDataTable.removeColumns(0,this.rewardDataTable.getNumberOfColumns()),this.choiceDataTable.removeRows(0,this.choiceDataTable.getNumberOfRows()),this.choiceDataTable.removeColumns(0,this.choiceDataTable.getNumberOfColumns()),this.objPerfDataTable.removeRows(0,this.objPerfDataTable.getNumberOfRows()),this.objPerfDataTable.removeColumns(0,this.objPerfDataTable.getNumberOfColumns()),this.perfDataTable.addColumn("number","currentTrial"),this.perfDataTable.addColumn("number","current"),this.perfDataTable.addColumn("number","100trialsAvg"),this.cumulDataTable.addColumn("datetime","time"),this.cumulDataTable.addColumn("number","Trials"),this.cumulDataTable.addColumn("number","Performance"),this.cumulDataTable.addColumn("number","RFID"),this.rxnTimeDataTable.addColumn("string","success"),this.rxnTimeDataTable.addColumn("number","durationMS"),this.xyPosDataTable.addColumn("number","xpos"),this.xyPosDataTable.addColumn("number","Fixation"),this.xyPosDataTable.addColumn("number","Sample"),this.realtimeDataTable.addColumn("number","globalX"),this.realtimeDataTable.addColumn("number","fixY"),this.realtimeDataTable.addColumn("number","sampleY"),e.data.SameDifferent<=0)for(let t=0;t<e.data.TestGridIndex.length;t++)this.xyPosDataTable.addColumn("number","Test"+(t+1)),this.realtimeDataTable.addColumn("number","testY"+(t+1));else e.data.SameDifferent>0&&(this.xyPosDataTable.addColumn("number","Same"),this.xyPosDataTable.addColumn("number","Different"),this.realtimeDataTable.addColumn("number","sameY"),this.realtimeDataTable.addColumn("number","differentY"));this.xyPosDataTable.addColumn("number","Fix_Reward"),this.xyPosDataTable.addColumn("number","Fix_Punish"),this.xyPosDataTable.addColumn("number","Target_Reward"),this.xyPosDataTable.addColumn("number","Target_Punish"),this.realtimeDataTable.addColumn("number","curY"),this.realtimeDataTable.addColumn({type:"string",role:"style"}),this.rewardDataTable.addColumn("string","reard size"),this.rewardDataTable.addColumn("number","nrewards"),this.choiceDataTable.addColumn("string","choice"),this.choiceDataTable.addColumn("number","# of responses"),this.objPerfDataTable.addColumn("string","object"),this.objPerfDataTable.addColumn("number","performance"),this.updatePlots(e,t)}updatePlots(e,t){let a;if(i.default.isUndefined(e.data))throw"file.data is Undefined";a=e.data,console.log("plot updated"),this.loadVitals(e),this.loadVitalsText(e),this.loadPerformanceData(e),this.loadObjPerfData(a),this.loadChoiceData(a),this.loadRewardData(a),this.drawPerformancePlot(e),this.drawTrialPlot(e),this.drawObjPerfPlot(),this.drawRxnTimePlot(),this.drawChoicePlot(),this.drawRewardPlot(),this.loadTouchSDText();let s=t.streamActive;this.drawScreenPlot(a,s),s&&!this.realtimePlotActive&&(console.log("hello"),this.drawRealtimePlot2(a),this.realtimePlotActive=!0)}loadVitals(e){let t;if(i.default.isUndefined(e.data))throw"file.data is Undefined";t=e.data,this.vitals.subject=t.Subject,this.vitals.trials=t.Response.length;let a=t.StartTime;this.vitals.time=i.default.round(i.default.round(i.default.toNumber(i.default.last(a))-a[0])/6e4);let s=t.RFIDTag;!i.default.isUndefined(s)&&i.default.size(s)>0?(this.vitals.rfidTag=s[i.default.size(s)-1][2],this.vitals.rfidTime=new Date(s[i.default.size(s)-1][1]).toLocaleTimeString("en-US")):(this.vitals.rfidTag=null,this.vitals.rfidTime=null),i.default.isUndefined(t.Automator)?this.vitals.automator=null:this.vitals.automator=e.data.Automator,i.default.isUndefined(t.CurrentAutomatorStage)?this.vitals.automatorStage=null:this.vitals.automatorStage=t.CurrentAutomatorStage,i.default.isUndefined(t.CurrentAutomatorStageName)?this.vitals.automatorStageName=null:this.vitals.automatorStageName=t.CurrentAutomatorStageName;let l=t.Battery;!i.default.isUndefined(l)&&i.default.size(l)>0?(this.vitals.batteryLeft=i.default.round(100*l[i.default.size(l)-1][2]),this.vitals.batteryUsed=i.default.round(100*l[0][2]-this.vitals.batteryLeft)):(this.vitals.batteryLeft=null,this.vitals.batteryUsed=null);let r=0;for(let e=0;e<i.default.size(t.CorrectItem);e++)t.CorrectItem[e]==t.Response[e]&&r++;this.vitals.numCorrect=r,this.vitals.pctCorrect=i.default.round(100*r/t.Response.length),i.default.isUndefined(t.NReward)||(this.vitals.numReward=t.NReward.reduce(((e,t)=>e+t),0)),this.vitals.rewardEstimate=0,i.default.isUndefined(t.RewardPer1000Trials)||(this.vitals.rewardEstimate=i.default.round(t.RewardPer1000Trials*this.vitals.numReward/1e3))}loadVitalsText(e){this.elemObject.perfVitals.innerHTML=`${this.vitals.subject}: ${this.vitals.pctCorrect}% (n = ${this.vitals.numCorrect} out of ${this.vitals.trials}, r=${this.vitals.numReward}=${this.vitals.rewardEstimate}mL, ${this.vitals.time} mins)`,this.elemObject.rfidVitals.innerHTML=`RFID: ${this.vitals.rfidTag} (${this.vitals.rfidTime})`,this.elemObject.batteryVitals.innerHTML=`Battery: ${this.vitals.batteryLeft}% (-${this.vitals.batteryUsed}%)`,this.elemObject.trialVitals.innerHTML="Last Trial: "+e.dateSaved.toLocaleTimeString("en-US")}loadTouchSDText(){try{this.screenPlotOptions.title=`Touch Locations -- standard dev: \n Fixation: ${Math.round(10*this.vitals.stdevFix)/10} pixels`;for(let e=0;e<this.vitals.stdevTest.length;e++)this.screenPlotOptions.title=this.screenPlotOptions.title+`\n Target ${e}: ${Math.round(10*this.vitals.stdevTest[e])/10}`}catch(e){console.error("Error loading touch SD text",e)}}loadPerformanceData(e){let t;if(i.default.isUndefined(e.data))throw"file.data is Undefined";t=e.data,this.perfDataTable.removeRows(0,this.perfDataTable.getNumberOfRows()),this.cumulDataTable.removeRows(0,this.cumulDataTable.getNumberOfRows()),this.rxnTimeDataTable.removeRows(0,this.rxnTimeDataTable.getNumberOfRows()),this.xyPosDataTable.removeRows(0,this.xyPosDataTable.getNumberOfRows());let a,s,l=[],o=[],n=[],d=[],h=[],u=[],f=[],m=[],c=[];for(let e=0;e<t.CorrectItem.length;e++)t.CorrectItem[e]==t.Response[e]?o[e]=1:o[e]=0,l[e]=e,h[e]=l.length,e>0?u[e]=u[e-1]+o[e]:0==e&&(u[e]=o[e]);for(let a=0;a<t.NReward.length;a++)0==t.RewardStage?(c[a]=t.FixationXYT[2][a]-t.StartTime[a],this.rxnTimeDataTable.addRows([[e.data.FixationTouchEvent[a],c[a]]])):t.NRSVP>0?(c[a]=t.SampleFixationXYT[2][a]-t.SampleStartTime[a],this.rxnTimeDataTable.addRows([[t.SampleFixationTouchEvent[a],c[a]]])):(c[a]=t.ResponseXYT[2][a]-t.SampleStartTime[a],-1==t.Response[a]?this.rxnTimeDataTable.addRows([["timeout",t.ChoiceTimeOut]]):t.CorrectItem[a]==t.Response[a]?this.rxnTimeDataTable.addRows([["correct",c[a]]]):this.rxnTimeDataTable.addRows([["wrong",c[a]]]));if(console.log(c),!i.default.isUndefined(t.ResponseXYT)&&i.default.size(t.ResponseXYT)>0&&i.default.size(e.data.ResponseXYT[0])>0)for(let a=0;a<2*i.default.size(t.ResponseXYT[0]);a+=2)m[a]=[],m[a+1]=[],m[a][0]=e.data.FixationXYT[0][a/2],m[a+1][0]=e.data.ResponseXYT[0][a/2],m[a][1]=e.data.FixationXYT[1][a/2],m[a+1][1]=e.data.ResponseXYT[1][a/2];else for(let a=0;a<2*i.default.size(t.ResponseXYT[0]);a+=2)m[a]=[],m[a+1]=[],m[a][0]=e.data.FixationXYT[0][a/2],m[a+1][0]=e.data.FixationXYT[0][a/2],m[a][1]=e.data.FixationXYT[1][a/2],m[a+1][1]=e.data.FixationXYT[1][a/2];let p,g,b,w,T=this.xyPosDataTable.getNumberOfColumns(),D=(this.realtimeDataTable.getNumberOfColumns(),this.getSampleWidth(e.data)),P=D,x=this.getTestWidth(e.data),F=x,v=this.getFixationWidth(e.data,D),C=v,R=this.getChoiceWidth(e.data),S=R,y=1,A=i.default.max(e.data.FixationGridIndex);if(!i.default.isNumber(A))throw"data.FixationGridIndex is not of type number[]";p=e.data.XGridCenter[A],g=e.data.ViewportPixels[1]-(e.data.YGridCenter[A]+e.data.offsettop),this.generateAndAddRowData(this.xyPosDataTable,T,{0:p-v/2,1:g-C/2}),this.generateAndAddRowData(this.xyPosDataTable,T,{0:p+v/2,1:g-C/2}),this.generateAndAddRowData(this.xyPosDataTable,T,{0:p+v/2,1:g+C/2}),this.generateAndAddRowData(this.xyPosDataTable,T,{0:p-v/2,1:g+C/2}),this.generateAndAddRowData(this.xyPosDataTable,T,{0:p-v/2,1:g-C/2}),this.realtimeRowDataAdded||this.realtimePlotActive||(this.rtData.fixation={x:p,y:g,width:v,height:C}),y=2;let O=i.default.max(t.SampleGridIndex);if(t.RewardStage>0){if(!i.default.isNumber(O))throw"data.SampleGridIndex is not of type number[]";b=t.XGridCenter[O],w=t.ViewportPixels[1]-(t.YGridCenter[O]+t.offsettop)}else b=p,w=g;this.generateAndAddRowData(this.xyPosDataTable,T,{0:b-D/2,2:w-P/2}),this.generateAndAddRowData(this.xyPosDataTable,T,{0:b+D/2,2:w-P/2}),this.generateAndAddRowData(this.xyPosDataTable,T,{0:b+D/2,2:w+P/2}),this.generateAndAddRowData(this.xyPosDataTable,T,{0:b-D/2,2:w+P/2}),this.generateAndAddRowData(this.xyPosDataTable,T,{0:b-D/2,2:w-P/2}),this.realtimeRowDataAdded||this.realtimePlotActive||(this.rtData.sample={x:b,y:w,width:D,height:P});let I=[],z=[];if(0!=t.RewardStage)for(let e=0;e<i.default.size(t.TestGridIndex)&&!(t.SameDifferent>0||t.NRSVP>0);e++)if(y++,t.NRSVP>0?(I.push(t.XGridCenter[O]),z.push(t.ViewportPixels[1]-(t.YGridCenter[O]+t.offsettop))):(I.push(t.XGridCenter[t.TestGridIndex[e]]),z.push(t.ViewportPixels[1]-(t.YGridCenter[t.TestGridIndex[e]]+t.offsettop))),this.generateAndAddRowData(this.xyPosDataTable,T,{0:I[e]-x/2,[y]:z[e]-F/2}),this.generateAndAddRowData(this.xyPosDataTable,T,{0:I[e]+x/2,[y]:z[e]-F/2}),this.generateAndAddRowData(this.xyPosDataTable,T,{0:I[e]+x/2,[y]:z[e]+F/2}),this.generateAndAddRowData(this.xyPosDataTable,T,{0:I[e]-x/2,[y]:z[e]+F/2}),this.generateAndAddRowData(this.xyPosDataTable,T,{0:I[e]-x/2,[y]:z[e]-F/2}),!this.realtimeRowDataAdded&&!this.realtimePlotActive){let t={x:I[e],y:z[e],width:x,height:F};this.rtData.test.push(t)}let j=[],V=[];if(0!=t.RewardStage&&t.SameDifferent>0)for(let e=0;e<i.default.size(t.ChoiceGridIndex);e++)y++,j.push(t.XGridCenter[t.ChoiceGridIndex[e]]),V.push(t.ViewportPixels[1]-(t.YGridCenter[t.ChoiceGridIndex[e]]+t.offsettop)),this.generateAndAddRowData(this.xyPosDataTable,T,{0:j[e]-R/2,[y]:V[e]-S/2}),this.generateAndAddRowData(this.xyPosDataTable,T,{0:j[e]+R/2,[y]:V[e]-S/2}),this.generateAndAddRowData(this.xyPosDataTable,T,{0:j[e]+R/2,[y]:V[e]+S/2}),this.generateAndAddRowData(this.xyPosDataTable,T,{0:j[e]-R/2,[y]:V[e]+S/2}),this.generateAndAddRowData(this.xyPosDataTable,T,{0:j[e]-R/2,[y]:V[e]-S/2}),this.realtimeRowDataAdded||this.realtimePlotActive||this.rtData.choice.push({x:j[e],y:V[e],width:R,height:S});this.realtimeRowDataAdded=!0;let N,E=[],L=[],M=[],G=[],U=[0,0];for(let e=0;e<m.length;e++){let l;if(a=m[e][0],s=t.ViewportPixels[1]-m[e][1],l=e%2==0?e/2:(e-1)/2,-1!=a){let r=new Array(T);if(r[0]=a,e%2==0)E.push(a),L.push(s),1==o[l]?(r[y+1]=s,this.xyPosDataTable.addRows([r])):(r[y+2]=s,this.xyPosDataTable.addRows([r]));else{let e=[],n=[];for(let r=0;r<i.default.size(t.TestGridIndex);r++)t.Response[l]==r?(e.push(a),n.push(s),U[r]+=1):(e.push(0),n.push(0)),M.push(e),G.push(n);1==o[l]?(r[y+3]=s,this.xyPosDataTable.addRows([r])):(r[y+4]=s,this.xyPosDataTable.addRows([r]))}}let r=i.default.mean(E),n=i.default.mean(L),d=E.map((e=>Math.pow(Math.abs(e-r),2))),h=L.map((e=>Math.pow(Math.abs(e-n),2))),u=d.map(((e,t)=>Math.sqrt(e+h[t]))).reduce(((e,t)=>e+t),0)/i.default.size(d);this.vitals.stdevFix=u;let f=[];for(let e=0;e<i.default.size(t.TestGridIndex);e++){let t=M.map((t=>t[e])).filter((e=>0!=e)),a=t.reduce(((e,t)=>e+t),0)/i.default.size(t),s=t.map((e=>Math.pow(Math.abs(e-a),2))),l=G.map((t=>t[e])).filter((e=>0!=e)),r=l.reduce(((e,t)=>e+t),0)/i.default.size(l),o=l.map((e=>Math.pow(Math.abs(e-r),2)));f.push(s.map(((e,t)=>Math.sqrt(e+o[t]))).reduce(((e,t)=>e+t),0)/i.default.size(t))}this.vitals.stdevTest=f}n=r.smooth(o,5),d=r.smooth(o,100),N=i.default.isUndefined(t.ResponseXYT)||i.default.size(t.ResponseXYT)<1||i.default.isUndefined(t.ResponseXYT[2][i.default.size(t.ResponseXYT[2])-1])?t.FixationXYT[2][i.default.size(t.FixationXYT[2])-1]:t.ResponseXYT[2][i.default.size(t.ResponseXYT[2])-1];let Y=i.default.size(o),k=i.default.size(t.RFIDTag);f=i.default.fill(Array(Y),0),this.vitals.tagCount={};for(let e=0;e<k;e++)i.default.isUndefined(this.vitals.tagCount[t.RFIDTag[e][2]])&&(this.vitals.tagCount[t.RFIDTag[e][2]]=0),this.vitals.tagCount[t.RFIDTag[e][2]]+=1,f[t.RFIDTag[e][0]]+=1;for(let e=1;e<i.default.size(f);e++)f[e]=f[e]+f[e-1];for(let a=0;a<i.default.size(o);a++){let i=t.FixationXYT[2][a];if(i<0)continue;let s=new Date(e.dateSaved);s.setTime(s.getTime()-(N-i)),this.perfDataTable.addRows([[l[a],n[a],d[a]]]),this.cumulDataTable.addRows([[s,h[a],u[a],f[a]]])}this.formatDate(this.cumulDataTable,0)}generateAndAddRowData(e,t,a){let s=[];for(let e=0;e<t;e++)i.default.has(a,e)?s.push(a[e]):s.push(null);e.addRows([s])}getSampleWidth(e){let t=0;if(i.default.size(e.SampleScenes[0].IMAGES.imageidx)>0)if(i.default.isArray(e.SampleScenes[0].IMAGES.sizeInches)){let a=i.default.max(e.SampleScenes[0].IMAGES.sizeInches);i.default.isNumber(a)&&(t=a*e.ViewportPPI)}else console.error("SampleScenes[0].IMAGES.sizeInches is not an array. Please fix!"),t=e.SampleScenes[0].IMAGES.sizeInches*e.ViewportPPI;else{let a=i.default.findKey(e.SampleScenes[0].OBJECTS);if(i.default.isString(a)){let s=i.default.max(e.SampleScenes[0].OBJECTS[a].sizeInches);i.default.isNumber(s)&&(t=s*e.ViewportPPI)}else console.error("firstKey of SampleScenes[0].OBJECTS is not of type string")}return t}getTestWidth(e){let t=0;if(e.TestScenes[0].IMAGES.imageidx.length>0)if(i.default.isArray(e.TestScenes[0].IMAGES.sizeInches)){let a=i.default.max(e.TestScenes[0].IMAGES.sizeInches);i.default.isNumber(a)?t=a*e.ViewportPPI:console.error("TestScenes[0].IMAGES.sizeInches is not of type number")}else console.error("TestScenes[0].IMAGES.sizeInches is not an array. Please fix!"),t=e.TestScenes[0].IMAGES.sizeInches*e.ViewportPPI;else{let a=i.default.findKey(e.TestScenes[0].OBJECTS);if(i.default.isString(a)){let s=i.default.max(e.TestScenes[0].OBJECTS[a].sizeInches);i.default.isNumber(s)?t=s*e.ViewportPPI:console.error("firstKey of TestScenes[0].OBJECTS is not of type string")}}return!i.default.isUndefined(e.NRSVP)&&e.NRSVP>0&&(t=e.SampleFixationSizeInches*e.ViewportPPI),t}getFixationWidth(e,t){let a=0;return a=e.FixationUsesSample<=0?e.FixationSizeInches*e.ViewportPPI:t,a}getChoiceWidth(e){let t=0;return!i.default.isUndefined(e.SameDifferent)&&e.SameDifferent>0&&(t=e.ChoiceSizeInches*e.ViewportPPI),t}loadObjPerfData(e){let t;if(this.objPerfDataTable.removeRows(0,this.objPerfDataTable.getNumberOfRows()),1==e.RewardStage){let a=[];if(e.NTrialsPerBagBlock>5e3)a.push(e.ImageBagsSample[0].split("/")[5]),this.objPerfDataTable.addRow([a[0],0]),t=1;else{for(let t=0;t<i.default.size(e.ImageBagsSample);t++)a.push(e.ImageBagsSample[t].split("/")[5]),this.objPerfDataTable.addRow([a[t],0]);t=i.default.size(a)}let s=i.default.fill(Array(t),0),l=i.default.fill(Array(t),0);for(let a=0;a<i.default.size(e.Sample[0]);a++)for(let i=0;i<t;i++)e.SampleBagIdx[e.Sample[0][a]]==i&&(l[i]+=1,e.Response[a]==e.CorrectItem[a]&&(s[i]+=1)),this.objPerfDataTable.setValue(i,1,s[i]/l[i])}}loadChoiceData(e){if(this.choiceDataTable.removeRows(0,this.choiceDataTable.getNumberOfRows()),0!=e.RewardStage){let t=[];if(0!=i.default.size(e.ObjectGridIndex)&&(i.default.isUndefined(e.NTrialsPerBagBlock)||e.NTrialsPerBagBlock<1e3)){let a=i.default.cloneDeep(e.ObjectGridIndex);a.sort(((e,t)=>e-t));let s=[];for(let l=0;l<i.default.size(a);l++)s.push(e.ObjectGridIndex.indexOf(a[l])),this.choiceDataTable.addRow([e.ImageBagsSample[s[l]].split("/")[5],0]),t.push(l)}else for(let a=0;a<i.default.size(e.TestGridIndex);a++)this.choiceDataTable.addRow(["choice"+(a+1),0]),t.push(a);let a=i.default.fill(Array(i.default.size(t)),0),s=0;for(let l=0;l<i.default.size(e.Response);l++){-1!=e.Response[l]&&s++;for(let r=0;r<i.default.size(t);r++)e.Response[l]==t[r]&&-1!=e.Response[l]&&a[r]++,this.choiceDataTable.setValue(r,1,a[r]/s)}}else{this.choiceDataTable.addRow(["outside Fix",0]),this.choiceDataTable.addRow(["inside Fix",0]);let t=i.default.fill(Array(2),0),a=0,s=[];for(let t=0;t<i.default.size(e.CorrectItem);t++)e.CorrectItem[t]==e.Response[t]?s.push(1):s.push(0);for(let e=0;e<i.default.size(s);e++){a++;for(let i=0;i<2;i++)s[e]==i&&(t[i]+=1),this.choiceDataTable.setValue(i,1,t[i]/a)}}}loadRewardData(e){this.rewardDataTable.removeRows(0,this.rewardDataTable.getNumberOfRows());let t=[];for(let a=0;a<e.NRewardMax;a++)t.push(a.toString());t.unshift("-1");for(let e=0;e<i.default.size(t);e++)this.rewardDataTable.addRow([t[e],0]);let a=i.default.fill(Array(i.default.size(t)),0);for(let s=0;s<i.default.size(e.NReward);s++)if(-1==e.Response[s])a[0]++,this.rewardDataTable.setValue(0,1,a[0]/i.default.size(e.NReward));else for(let l=1;l<i.default.size(t);l++)e.NReward[s].toString()==t[l]&&a[l]++,this.rewardDataTable.setValue(l,1,a[l]/i.default.size(e.NReward))}drawPerformancePlot(e){var t;let a=this.perfDataTable.getNumberOfRows();this.nTrials=a;let s=this.perfFilter.getState();if(e.dataChanged&&!e.fileChanged)if(a<=100)s.range.start=0,s.range.end=a;else{let l=a-i.default.size(null===(t=e.data)||void 0===t?void 0:t.FixationGridIndex);console.log("dtrials",l),s.range.start=a-100,s.range.end=a}else if(e.fileChanged){let e=100;s.range.start=a-e,s.range.end=a,s.range.start<0&&(s.range.start=0)}this.perfPlot.setOptions(this.perfPlotOptions),this.perfFilter.setState({range:{start:s.range.start,end:s.range.end}}),this.perfDashboard.draw(this.perfDataTable)}drawTrialPlot(e){let t=this.trialFilter.getState(),a=new Date(this.cumulDataTable.getColumnRange(0).min),i=new Date(this.cumulDataTable.getColumnRange(0).max);(e.dataChanged||e.fileChanged)&&(t.range.start=a,t.range.end=i),this.trialFilter.setState({range:{start:t.range.start,end:t.range.end}}),this.trialPlot.setOptions(this.trialPlotOptions),this.trialDashboard.draw(this.cumulDataTable)}drawObjPerfPlot(){this.objPerfPlot.draw(this.objPerfDataTable,this.objPerfPlotOptions)}drawRxnTimePlot(){this.rxnPlot.draw(this.rxnTimeDataTable,this.rxnPlotOptions)}drawChoicePlot(){this.choicePlot.draw(this.choiceDataTable,this.choicePlotOptions)}drawRewardPlot(){this.rewardPlot.draw(this.rewardDataTable,this.rewardPlotOptions)}drawRealtimePlot(e){this.realtimePlotOptions={seriesType:"scatter",width:e.workspace[2]*e.CanvasRatio,height:e.ViewportPixels[1]-e.offsettop,legend:{position:"top"},hAxis:{title:"X position (px)",viewWindow:{min:0,max:e.workspace[2]*e.CanvasRatio}},vAxis:{title:"Y position (px)",viewWindow:{min:0,max:e.ViewportPixels[1]-e.offsettop}}},this.realtimePlotOptions.hAxis={title:"X position (px)",viewWindow:{min:0,max:e.workspace[2]*e.CanvasRatio}},this.realtimePlotOptions.vAxis={title:"Y position (px)",viewWindow:{min:0,max:e.ViewportPixels[1]-e.offsettop}};let t=this.realtimeDataTable.getNumberOfColumns();this.generateAndAddRowData(this.realtimeDataTable,t,{0:0,[t-2]:0});let a=this.realtimeDataTable.getNumberOfRows();this.realtimePlotConfig={chartType:"ComboChart",containerId:"realtime-plot",options:this.realtimePlotOptions},this.realtimePlot=new google.visualization.ChartWrapper(this.realtimePlotConfig),this.realtimePlot.setDataTable(this.realtimeDataTable),window.addEventListener("data_arrived",(e=>{this.realtimeDataTable.setValue(a-1,0,Math.floor(e.detail.x)),this.realtimeDataTable.setValue(a-1,t-2,Math.floor(e.detail.y)),this.realtimePlot.draw()}))}drawStaticElements(e,t,a){if(t){t.fillStyle="gray",t.fillRect(0,0,a.workspace[2]*a.CanvasRatio,a.ViewportPixels[1]-a.offsettop),a.FixationUsesSample<1&&(t.strokeStyle="#0000FF",t.beginPath(),t.arc(this.rtData.fixation.x,e.height-this.rtData.fixation.y,this.rtData.fixation.width/2,0,2*Math.PI,!0),t.stroke()),t.strokeStyle="#000000",t.beginPath(),t.rect(this.rtData.sample.x-this.rtData.sample.width/2,e.height-(this.rtData.sample.y+this.rtData.sample.height/2),this.rtData.sample.width,this.rtData.sample.height),t.stroke();for(let a=0;a<i.default.size(this.rtData.test);a++)console.log("test"),t.beginPath(),t.rect(this.rtData.test[a].x-this.rtData.test[a].width/2,e.height-(this.rtData.test[a].y+this.rtData.test[a].height/2),this.rtData.test[a].width,this.rtData.test[a].height),t.stroke();for(let a=0;a<i.default.size(this.rtData.choice);a++)t.beginPath(),t.rect(this.rtData.choice[a].x-this.rtData.choice[a].width/2,e.height-(this.rtData.choice[a].y+this.rtData.choice[a].height/2),this.rtData.choice[a].width,this.rtData.choice[a].height),t.stroke();let s=a.FixationWindowSizeInches;i.default.isNumber(s)&&s>0&&(t.strokeStyle="#FFFF00",t.strokeRect(this.rtData.fixation.x-i.default.floor(s/2*a.ViewportPPI),e.height-(this.rtData.fixation.y+i.default.floor(s/2*a.ViewportPPI)),i.default.floor(s*a.ViewportPPI),i.default.floor(s*a.ViewportPPI)))}}drawRealtimePlot2(e){let t=document.querySelector("#realtime-canvas");t.width=e.workspace[2]*e.CanvasRatio,t.height=e.ViewportPixels[1]-e.offsettop;let a=t.getContext("2d");this.drawStaticElements(t,a,e),window.addEventListener("data_arrived",(s=>{2==s.detail.meta&&this.drawStaticElements(t,a,e),1==s.detail.meta?a.fillStyle="green":0==s.detail.meta&&(a.fillStyle="red"),null==a||a.beginPath();let l=i.default.floor(s.detail.x),r=i.default.floor(t.height-s.detail.y);null==a||a.arc(l,r,2,0,2*Math.PI,!0),null==a||a.fill()}))}drawScreenPlot(e,t){this.screenPlotOptions.series=[];for(let e=0;e<this.xyPosDataTable.getNumberOfColumns();e++)"Fixation"==this.xyPosDataTable.getColumnLabel(e)?this.screenPlotOptions.series[e-1]={type:"line",color:"gray"}:"Sample"==this.xyPosDataTable.getColumnLabel(e)?this.screenPlotOptions.series[e-1]={type:"line",color:"black"}:"Same"==this.xyPosDataTable.getColumnLabel(e)?this.screenPlotOptions.series[e-1]={type:"line",color:"green"}:"Different"==this.xyPosDataTable.getColumnLabel(e)?this.screenPlotOptions.series[e-1]={type:"line",color:"red"}:"Fix_Reward"==this.xyPosDataTable.getColumnLabel(e)?this.screenPlotOptions.series[e-1]={color:"blue"}:"Fix_Punish"==this.xyPosDataTable.getColumnLabel(e)?this.screenPlotOptions.series[e-1]={color:"red"}:"Target_Reward"==this.xyPosDataTable.getColumnLabel(e)?this.screenPlotOptions.series[e-1]={color:"green"}:"Target_Punish"==this.xyPosDataTable.getColumnLabel(e)?this.screenPlotOptions.series[e-1]={color:"black"}:this.xyPosDataTable.getColumnLabel(e).includes("Test")&&(this.screenPlotOptions.series[e-1]={type:"line",color:"black"});this.screenPlotOptions.height=e.ViewportPixels[1],this.screenPlotOptions.width=e.ViewportPixels[0],this.screenPlotOptions.hAxis={title:"X position (px)",viewWindow:{min:0,max:e.ViewportPixels[0]}},this.screenPlotOptions.vAxis={title:"Y position (px)",viewWindow:{min:0,max:e.ViewportPixels[1]}},this.realtimePlotActive||this.screenPlot.draw(this.xyPosDataTable,this.screenPlotOptions)}formatDate(e,t){new google.visualization.DateFormat({pattern:"h aa"}).format(e,t)}formatNumber(e,t){new google.visualization.NumberFormat({fractionDigits:2}).format(e,t)}formatColor(e,t){let a=new google.visualization.ColorFormat,i=1/(l.length-1);for(let e=0;e<l.length;e++)a.addRange(e*i,(e+1)*i,"gray",l[e]);a.format(e,t)}}},739:(e,t,a)=>{Object.defineProperty(t,"__esModule",{value:!0}),t.Liveplot=void 0;const i=a(655),s=i.__importDefault(a(503));a(779),a(668),a(642);const l=i.__importDefault(a(807)),r=i.__importDefault(a(486)),o=a(593),n=a(652),d=s.default.storage().ref(),h=s.default.database(),u="mkturkfiles/datafiles/",f=(d.child(u),d.child("mkturkfiles/parameterfiles/subjects/"),h.ref("agents/"),new o.Utils);t.Liveplot=class{constructor(e){this.elemObjs=e,this.file={path:u,list:[],name:"",ver:null,date:null,dataChanged:!1,fileChanged:!1},this.charts=new n.Charts(e),this.streamActive=!1,this.requestRealtimeBtnAction(),this.onDisconnectAction()}fileSelectionChangedListener(e){e.addEventListener("input",(t=>{var a;if(t.stopPropagation(),t.preventDefault(),this.streamActive){let e=null===(a=this.file.data)||void 0===a?void 0:a.Agent;h.ref("data/"+e).off(),this.agentClientRef.remove((e=>{e&&console.error("Error Removing agentClientRef: "+e)})),this.streamActive=!1}this.file.name=this.file.list[parseInt(e.value)].fullpath,this.file.fileChanged=!0}))}onDisconnectAction(){window.addEventListener("unload",(e=>{this.agentClientRef.onDisconnect().remove()}))}requestRealtimeBtnAction(){let e=this.elemObjs.realtimeBtn;e.addEventListener("click",(async t=>{var a;t.stopPropagation(),t.preventDefault();let i=null===(a=this.file.data)||void 0===a?void 0:a.Agent;if(this.streamActive)e.innerHTML="Request Realtime Stream",h.ref("data/"+i).off(),this.agentClientRef.remove((e=>{e&&console.error("Error Removing agentClientRef: "+e)})),h.ref("data/"+i).off(),this.streamActive=!1;else{e.innerHTML="Deactivate Realtime Stream";let t=h.ref("agents/"+i).push().key;this.agentClientRef=h.ref(`agents/${i}/${t}`),r.default.isString(t)&&h.ref("agents/"+i).update({[t]:!0}),h.ref("data/"+i).on("value",(e=>{let t=new CustomEvent("data_arrived",{detail:e.val()});window.dispatchEvent(t)})),this.streamActive=!0}}))}async populateFileList(e){try{let t=await f.getFileList(this.file.path);t.sort(((e,t)=>{let a=e.name.toUpperCase(),i=t.name.toUpperCase();return a>i?-1:a<i?1:0})),this.file.list=t;for(let a=0;a<t.length;a++){let i=document.createElement("option");i.value=a.toString(),i.innerHTML=t[a].name,e.appendChild(i)}this.file.name=this.file.list[0].fullpath,this.file.fileChanged=!0;let a=await f.getStorageFile(this.file.name);console.log("rawFile",a),this.processData(a)}catch(e){console.error("ERROR #file-list:",e)}}flattenData(e){let t={};for(let a in e)if(e.hasOwnProperty(a))for(let i in e[a])e[a].hasOwnProperty(i)&&(t[i]=e[a][i]);return t}async processData(e){this.file.data=this.flattenData(e),this.loadDataToEditor(this.file.data);let t=await f.getStorageFileMetadata(this.file.name);console.log("Success! Loaded File Size:",t.size/1e3,"KB"),this.file.ver=t.generation,this.file.dateSaved=new Date(t.updated),console.log(this.file.dateSaved),this.file.fileChanged?(this.charts.initializeChartData(this.file,{streamActive:this.streamActive}),this.checkFileStatus(),this.file.fileChanged=!1,this.file.dataChanged=!1):this.file.dataChanged&&(this.charts.updatePlots(this.file,{streamActive:this.streamActive}),this.file.dataChanged=!1,this.checkFileStatus())}setupEditor(e){this.editor=new l.default(e)}loadDataToEditor(e){this.file.fileChanged?this.editor.set(e):this.editor.update(e)}async checkFileStatus(){try{let e=await f.getStorageFileMetadata(this.file.name);if(this.file.ver!=e.generation?(this.file.ver=e.generation,this.file.dateSaved=new Date(e.updated),console.log(this.file.dateSaved),this.file.dataChanged=!0,console.log("File was updated ver="+this.file.ver)):this.file.dataChanged=!1,1==this.file.fileChanged||1==this.file.dataChanged){let e=await f.getStorageFile(this.file.name);this.processData(e)}else setTimeout((()=>{this.checkFileStatus()}),1e3)}catch(e){console.error("checkFileStatus Error:",e)}return!1}}},519:(e,t,a)=>{const i=a(655);a(279);const s=i.__importDefault(a(503));a(397),s.default.initializeApp({apiKey:"AIzaSyA0fbv2VqE-AfF6V_nxSSXCEqaTlBlZnTI",authDomain:"sandbox-ce2c5.firebaseapp.com",databaseURL:"https://sandbox-ce2c5.firebaseio.com",projectId:"sandbox-ce2c5",storageBucket:"sandbox-ce2c5.appspot.com",messagingSenderId:"1003719887944",clientId:"1003719887944-rlc06cjecqrp9fgvmvo56vqop1otm9ht.apps.googleusercontent.com"});const l=a(739);let r=document.querySelector("#file-list"),o=document.querySelector("#editor"),n={perfDiv:document.querySelector("#performance-dashboard"),perfPlot:document.querySelector("#performance-plot"),perfFilter:document.querySelector("#performance-filter"),trialDiv:document.querySelector("#trial-dashboard"),trialPlot:document.querySelector("#trial-plot"),trialFilter:document.querySelector("#trial-filter"),screenPlot:document.querySelector("#screen-plot"),rxnPlot:document.querySelector("#reaction-plot"),choicePlot:document.querySelector("#choice-plot"),objPerfPlot:document.querySelector("#obj-perf-plot"),rewardPlot:document.querySelector("#reward-plot"),perfVitals:document.querySelector("#performance-vitals"),rfidVitals:document.querySelector("#rfid-vitals"),batteryVitals:document.querySelector("#battery-vitals"),trialVitals:document.querySelector("#trial-vitals"),fixStdev:document.querySelector("#fixation-stdev"),tarZeroStdev:document.querySelector("#target0-stdev"),tarOneStdev:document.querySelector("#target1-stdev"),sdTextDiv:document.querySelector("#touch-sd-text"),realtimeBtn:document.querySelector("#request-realtime")};const d=new l.Liveplot(n);d.setupEditor(o),d.fileSelectionChangedListener(r),d.populateFileList(r);let h=new s.default.auth.GoogleAuthProvider;h.addScope("https://www.googleapis.com/auth/contacts.readonly"),s.default.auth().getRedirectResult().then((function(e){e.user?console.log("Sign-In Redirect Result, USER "+e.user.email+" is signed in"):s.default.auth().currentUser?console.log("Sign-In Redirect Result, USER is signed in"):s.default.auth().signInWithRedirect(h)}))},593:(e,t,a)=>{Object.defineProperty(t,"__esModule",{value:!0}),t.Utils=void 0;const i=a(655).__importDefault(a(503));a(668),a(642);const s=i.default.storage().ref();t.Utils=class{constructor(){}async getFileList(e,t){let a=await s.child(e).listAll(),i=(new Date).getFullYear(),l=[];for(let i of a.prefixes){let a=await this.getFileList(e+i.name+"/",t);l=[...l,...a]}for(let e=0;e<a.items.length;e++)"string"==typeof t?a.items[e].name.endsWith(t)&&l.push({fullpath:a.items[e].fullPath,name:a.items[e].name}):parseInt(a.items[e].name.slice(0,4))>=i-1&&l.push({fullpath:a.items[e].fullPath,name:a.items[e].name});return l}async getStorageFile(e){let t=s.child(e),a=await t.getDownloadURL().catch((e=>{console.error("Error Getting URL")})),i=await fetch(a);return await i.json()}async getStorageFileMetadata(e){let t=s.child(e);return await t.getMetadata()}smooth(e,t){let a=[];for(let i=0;i<e.length;i++)if(i<t-1){let t=e.slice(0,i+1);a[i]=t.reduce(((e,t)=>e+t)),a[i]/=i+1}else{let s=e.slice(i-t+1,i+1);a[i]=s.reduce(((e,t)=>e+t)),a[i]/=t}return a}calcDistance(e,t){return Math.pow(Math.abs(e-t),2)}}}},t={};function a(i){if(t[i])return t[i].exports;var s=t[i]={id:i,loaded:!1,exports:{}};return e[i].call(s.exports,s,s.exports,a),s.loaded=!0,s.exports}a.m=e,a.d=(e,t)=>{for(var i in t)a.o(t,i)&&!a.o(e,i)&&Object.defineProperty(e,i,{enumerable:!0,get:t[i]})},a.g=function(){if("object"==typeof globalThis)return globalThis;try{return this||new Function("return this")()}catch(e){if("object"==typeof window)return window}}(),a.hmd=e=>((e=Object.create(e)).children||(e.children=[]),Object.defineProperty(e,"exports",{enumerable:!0,set:()=>{throw new Error("ES Modules may not assign module.exports or exports.*, Use ESM export syntax, instead: "+e.id)}}),e),a.o=(e,t)=>Object.prototype.hasOwnProperty.call(e,t),a.r=e=>{"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},a.nmd=e=>(e.paths=[],e.children||(e.children=[]),e),(()=>{var e={179:0},t=[[519,802],[593,802]],i=()=>{};function s(){for(var i,s=0;s<t.length;s++){for(var l=t[s],r=!0,o=1;o<l.length;o++){var n=l[o];0!==e[n]&&(r=!1)}r&&(t.splice(s--,1),i=a(a.s=l[0]))}return 0===t.length&&(a.x(),a.x=()=>{}),i}a.x=()=>{a.x=()=>{},r=r.slice();for(var e=0;e<r.length;e++)l(r[e]);return(i=s)()};var l=s=>{for(var l,r,[n,d,h,u]=s,f=0,m=[];f<n.length;f++)r=n[f],a.o(e,r)&&e[r]&&m.push(e[r][0]),e[r]=0;for(l in d)a.o(d,l)&&(a.m[l]=d[l]);for(h&&h(a),o(s);m.length;)m.shift()();return u&&t.push.apply(t,u),i()},r=self.webpackChunkliveplot2=self.webpackChunkliveplot2||[],o=r.push.bind(r);r.push=l})(),a.x()})();
//# sourceMappingURL=main.bundle.js.map